<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QPWON – Scoring Sprint (Auto‑Analyzer + Proxy‑ready)</title>
  <meta name="description" content="Inserisci l'URL del sito: il tool analizza e restituisce lo score per area. Con proxy opzionale per superare CORS." />
  <style>
    :root{
      --bg:#0f1220; --bg-soft:#151a2e; --card:#1b2140; --muted:#8ea1c0; --text:#e7ecff;
      --good:#2ecc71; --warn:#f1c40f; --cold:#4aa3ff; --accent:#7c5cff; --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,var(--bg),#0c101d);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;}
    a{color:var(--accent)}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{position:sticky;top:0;z-index:10;background:rgba(15,18,32,.75);backdrop-filter: blur(10px);border-bottom:1px solid #20264a}
    .topbar{display:flex;gap:12px;align-items:center;padding:12px 16px;}
    .brand{font-weight:700;letter-spacing:.5px}
    .pill{padding:6px 10px;border-radius:999px;background:#21284f;border:1px solid #2a3260;color:#8ea1c0;font-size:12px}
    .spacer{flex:1}
    button,.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#2a3260;color:#fff;cursor:pointer;box-shadow: var(--shadow);transition:transform .06s ease, filter .2s ease;}
    button:hover{filter:brightness(1.05)}
    button:active{transform: translateY(1px)}
    .btn-ghost{background:transparent;border:1px solid #33407a}
    .btn-accent{background: var(--accent)}
    .btn-good{background: var(--good);color:#08130d}
    .btn-danger{background: var(--danger)}

    main{padding:18px;display:grid;grid-template-columns: 1.3fr 1fr 1.1fr;gap:18px}
    @media (max-width:1200px){ main{grid-template-columns:1fr;} }

    .card{background: linear-gradient(180deg, var(--card), #151a2e); border:1px solid #283060; border-radius: var(--radius); box-shadow: var(--shadow);}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #2a3260;font-size:16px;color:#c9d6ff;display:flex;align-items:center;gap:10px}
    .card .content{padding:14px 16px}
    .row{display:flex;gap:10px}
    .col{display:flex;flex-direction:column;gap:10px}
    label{font-size:12px;color:#8ea1c0}
    input[type="url"], input[type="tel"], textarea {width:100%;padding:10px 12px;border-radius:10px;border:1px solid #33407a;background:#0e1430;color:#e7ecff;outline:none}
    textarea{min-height:76px;resize:vertical}
    .progress{height:8px;background:#0d1430;border:1px solid #25305b;border-radius:999px;overflow:hidden}
    .progress > div{height:100%;background:linear-gradient(90deg,var(--accent),#5c87ff);width:0%}
    .bookmarklet{display:flex;gap:10px;align-items:center;background:#0e1430;border:1px dashed #2a3260;padding:10px;border-radius:12px}
    .bookmarklet a{display:inline-block;padding:8px 10px;border:1px solid #2a3260;border-radius:8px;background:#1a2350;color:#fff;text-decoration:none}

    .gauge-wrap{display:flex;align-items:center;justify-content:center;padding:10px 0}
    .gauge{width:280px;height:160px;position:relative}
    .gauge svg{width:100%;height:100%}
    .needle{transform-origin: 140px 140px; transition: transform .4s ease-in-out}
    .score-big{font-size:48px;font-weight:800;text-align:center;margin-top:-6px}
    .band{display:flex;gap:8px;justify-content:center;margin-top:4px}
    .band .dot{width:12px;height:12px;border-radius:50%}
    .dot.hot{background:var(--good)} .dot.warm{background:var(--warn)} .dot.cold{background:var(--cold)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:13px;padding:8px 10px;text-align:left}
    thead th{color:#bcd0ff}
    tbody tr{background:#12183a;border:1px solid #283060}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:2px 6px;border-radius:999px;font-size:11px;border:1px solid #33407a;color:#cfe1ff}
    .conf-low{background:#241a3e} .conf-mid{background:#1f2b55} .conf-high{background:#1a3e2d}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="topbar">
        <div class="brand">QPWON · <span class="muted">Scoring Sprint</span></div>
        <span class="pill">Auto‑Analyzer + Proxy‑ready</span>
        <div class="spacer"></div>
        <button id="btnSettings" class="btn-ghost">Impostazioni</button>
        <button id="exportCSV" class="btn-ghost">Export CSV</button>
        <button id="exportJSON" class="btn-ghost">Export JSON</button>
        <label class="btn-ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">Import JSON
          <input id="importJSON" type="file" accept="application/json" style="display:none" />
        </label>
        <button id="resetAll" class="btn-danger">Reset</button>
      </div>
    </header>

    <main>
      <section class="card">
        <h2>1) URL → Analisi automatica</h2>
        <div class="content col">
          <div class="row">
            <input id="url" type="url" placeholder="Incolla l'URL (es. https://www.polixyz.it)" />
            <button id="analyze" class="btn-accent">Analizza</button>
          </div>
          <div class="progress"><div id="pbar"></div></div>
          <div id="status" class="muted">Pronto.</div>

          <details>
            <summary class="muted">Se il sito blocca (CORS), alternative</summary>
            <div class="bookmarklet">
              <div>1) Trascina questo:</div>
              <a id="bm" href="#">Analizza questa pagina</a>
              <div>2) Sul sito del centro cliccalo → copia il testo.<br/>3) Torna qui, incolla sotto e premi <strong>Analizza testo</strong>.</div>
            </div>
            <textarea id="pasted" placeholder="Incolla qui il testo copiato dal sito…"></textarea>
            <div class="right"><button id="analyzePasted" class="btn-ghost">Analizza testo</button></div>
          </details>
        </div>
      </section>

      <section class="card">
        <h2>2) Score complessivo & aree</h2>
        <div class="content col">
          <div class="gauge-wrap">
            <div class="gauge">
              <svg viewBox="0 0 280 160" xmlns="http://www.w3.org/2000/svg" aria-label="Gauge">
                <defs>
                  <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="var(--cold)"/>
                    <stop offset="50%" stop-color="var(--warn)"/>
                    <stop offset="100%" stop-color="var(--good)"/>
                  </linearGradient>
                </defs>
                <path d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="#23305e" stroke-width="16" stroke-linecap="round"/>
                <path id="arc" d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="url(#grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 377"/>
                <g id="needle" class="needle">
                  <line x1="140" y1="140" x2="140" y2="42" stroke="#e7ecff" stroke-width="4"/>
                  <circle cx="140" cy="140" r="6" fill="#e7ecff"/>
                </g>
              </svg>
            </div>
          </div>
          <div class="score-big" id="scoreText">0.0</div>
          <div class="band"><span>Pallino:</span> <span class="dot cold" id="dot"></span> <span id="tempText" class="muted">freddo</span></div>
          <div class="muted" id="coverage">Copertura segnali: 0%</div>

          <table>
            <thead>
              <tr>
                <th>Area</th><th>Score</th><th>Confidenza</th><th>Evidenza</th>
              </tr>
            </thead>
            <tbody id="areasBody"></tbody>
          </table>
        </div>
      </section>

      <section class="card">
        <h2>3) Script & coda</h2>
        <div class="content col">
          <label>Nome struttura</label>
          <input id="name" type="text" placeholder="Es. Poliambulatorio XYZ" />
          <label>Città</label>
          <input id="city" type="text" placeholder="Es. Bologna" />
          <label>Telefono (per chiamata/WA)</label>
          <input id="phone" type="tel" placeholder="+39…" />

          <label>Script (WhatsApp / Email)</label>
          <textarea id="script" placeholder="Verrà generato automaticamente…"></textarea>
          <div class="row right">
            <button id="btnWA" class="btn-good">WhatsApp</button>
            <button id="btnCall">Chiama</button>
            <button id="btnEmail" class="btn-ghost">Email</button>
          </div>

          <div class="row">
            <button id="saveQueue" class="btn-accent">Salva & metti in coda</button>
            <input id="search" type="text" placeholder="Cerca nella coda… (nome, città)" />
          </div>

          <table>
            <thead><tr><th>Priorità</th><th>Struttura</th><th>Città</th><th>Score</th><th>Azioni</th></tr></thead>
            <tbody id="queueBody"></tbody>
          </table>
        </div>
      </section>
    </main>

    <dialog id="dlg">
      <form method="dialog" style="min-width: min(640px, 95vw); background:#0e1430; border:1px solid #2a3260; color:#e7ecff; border-radius:16px; padding:16px">
        <h3 style="margin:0 0 10px 0;">Impostazioni</h3>
        <div style="display:grid; gap:10px;">
          <label style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="forceProxy" /> Forza uso proxy per tutte le richieste
          </label>
          <div>
            <label>Endpoint Proxy (Cloudflare Worker o server tuo)</label>
            <input id="proxyEndpoint" type="url" placeholder="https://TUO-WORKER.workers.dev/?url=" />
            <div class="hint">Accetta <code>?url=https://sito.it</code> e restituisce JSON <code>{ html }</code>. Vedi <strong>worker.js</strong>.</div>
          </div>
        </div>
        <div class="right" style="margin-top:10px">
          <button value="cancel" class="btn-ghost">Chiudi</button>
          <button id="saveSettings" class="btn-accent">Salva</button>
        </div>
      </form>
    </dialog>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const STORAGE_KEY = 'qpwon_scoring_proxy_v2';
    function setStatus(msg){ $('#status').textContent = msg; }
    function setProgress(pct){ $('#pbar').style.width = pct + '%'; }
    function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }
    function uuid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
    const Settings = {
      load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { proxyEndpoint:'', forceProxy:false, leads:[] }; }catch{ return { proxyEndpoint:'', forceProxy:false, leads:[] }; } },
      save(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }
    };
    let state = Settings.load();

    (function initBookmarklet(){
      const code = `(function(){try{var t=document.body.innerText||document.body.textContent||'';if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t.slice(0,200000)).then(function(){alert('Testo copiato. Torna al tool e clicca \'Analizza testo\'.')}).catch(function(e){prompt('Copia questo testo e incollalo nel tool:',t.slice(0,8000))});}else{prompt('Copia questo testo e incollalo nel tool:',t.slice(0,8000));}}catch(e){alert('Errore: '+e.message)}})();`;
      $('#bm').setAttribute('href','javascript:'+encodeURIComponent(code));
    })();

    const AREAS = ['booking','telefonate','orari','whatsapp','crescita','doppioSistema','dimensione','serviziCall','decisionMaker','numeroDiretto'];
    const WEIGHTS = { booking:2, telefonate:2, orari:1, whatsapp:1, crescita:2, doppioSistema:2, dimensione:2, serviziCall:1, decisionMaker:1, numeroDiretto:1 };

    function analyzeTexts(texts){
      const concat = texts.map(t => (t.text||'') + ' ').join(' ').toLowerCase();
      const score = {}, conf = {}, evidence = {};
      const md = /miodottore/.test(concat), dl = /doctolib/.test(concat), book = /(prenota|prenotazione|booking|appuntamenti)/.test(concat);
      if(!book){ score.booking=10; conf.booking='mid'; evidence.booking='Nessuna traccia di prenotazione online'; }
      else if(md && dl){ score.booking=7; conf.booking='high'; evidence.booking='MD+DL entrambi presenti'; }
      else if(md || dl){ score.booking=6; conf.booking='high'; evidence.booking='Portale esterno rilevato'; }
      else { score.booking=5; conf.booking='mid'; evidence.booking='Prenotazione presente ma potenzialmente confusa'; }
      const telRe=/(linee occupate|sempre occupato|attesa|richiama|solo telefono|chiamare per prenotare)/;
      score.telefonate = telRe.test(concat) ? 8 : (book ? 3 : 7);
      conf.telefonate = telRe.test(concat)?'mid':'low';
      evidence.telefonate = telRe.test(concat)?'Testo con attese/telefono':'Indizio indiretto';
      const hasSat=/(sab|sabato)/.test(concat), times=concat.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/g)||[], late=times.some(t=>{const[h,m]=t.split(':').map(Number);return h>19||(h===19&&m>=30)});
      score.orari=(hasSat||late)?8:3; conf.orari=(hasSat||late)?'mid':'low'; evidence.orari=(hasSat?'sabato ':'')+(late?'orari ≥19:30':'');
      const wa=/(wa\.me|api\.whatsapp|whatsapp)/.test(concat); score.whatsapp=wa?7:2; conf.whatsapp=wa?'high':'low'; evidence.whatsapp=wa?'Link/menzione WhatsApp':'Nessuna evidenza';
      const gr=/(nuova sede|apertura|stiamo assumendo|lavora con noi|apre|nuovo centro|nuovi macchinari|campagna|promozione)/.test(concat);
      score.crescita=gr?8:3; conf.crescita=gr?'mid':'low'; evidence.crescita=gr?'Parole chiave di crescita':'Nessuna evidenza';
      if(md&&dl){ score.doppioSistema=9; conf.doppioSistema='high'; evidence.doppioSistema='MD+DL rilevati'; } else { score.doppioSistema=2; conf.doppioSistema='mid'; evidence.doppioSistema='Nessun doppio sistema chiaro'; }
      const medRe=/(dott\.|dottore|dottoressa|dr\.|medico|specialista)/g; const hits=(concat.match(medRe)||[]).length;
      score.dimensione = (hits>=3 && hits<=20)?9 : (hits>20 && hits<=40)?6 : (hits>40)?5 : 3; conf.dimensione=hits>0?'low':'low'; evidence.dimensione='Occorrenze parole-medico: '+hits;
      const hiRe=/(prelievi|analisi|fisioterapia|oculistica|ecografia|radiologia|tac|risonanza)/; score.serviziCall=hiRe.test(concat)?7:3; conf.serviziCall=hiRe.test(concat)?'mid':'low'; evidence.serviziCall=hiRe.test(concat)?'Servizi ad alta chiamata presenti':'Nessuna evidenza';
      const dmRe=/(direzione sanitaria|direttore sanitario|amministrazione|titolare|responsabile)/; score.decisionMaker=dmRe.test(concat)?7:3; conf.decisionMaker=dmRe.test(concat)?'mid':'low'; evidence.decisionMaker=dmRe.test(concat)?'Ruolo/contatto di direzione':'Nessuna evidenza';
      const ph=/((\+?39\s?)?0?\d[\d\s\-\.]{6,})/; const hasPh=ph.test(concat); const pre=/(prenotazioni|segreteria|cup|centralino|accettazione)/;
      score.numeroDiretto=hasPh?(pre.test(concat)?7:5):2; conf.numeroDiretto=hasPh?'mid':'low'; evidence.numeroDiretto=hasPh?'Telefono presente':'Nessuna evidenza';
      const coverage = Math.round(100 * (Object.keys(score).length / AREAS.length));
      return { score, conf, evidence, coverage };
    }
    function areaLabel(k){ return {booking:'Prenotazione online migliorabile/assente',telefonate:'Traffico telefonico/attese',orari:'Orari estesi/sabato (alto afflusso)',whatsapp:'WhatsApp presente (rischio non presidiato)',crescita:'Segnali di crescita (sede/assunzioni/adv)',doppioSistema:'Doppio sistema MD+DL',dimensione:'Taglia 3–20 medici (stimata)',serviziCall:'Servizi ad alta chiamata presenti',decisionMaker:'Decision maker identificabile',numeroDiretto:'Numero diretto/centralino rilevato'}[k]||k; }
    function confBadge(c){ const map={low:'conf-low',mid:'conf-mid',high:'conf-high'}; return `<span class="badge ${map[c]||'conf-low'}">${c||'low'}</span>`; }
    function renderAreas(score, conf, evidence){
      $('#areasBody').innerHTML = AREAS.map(a=>{
        const s = (score[a]??0).toFixed(1); const c = confBadge(conf[a]); const ev = evidence[a]?escapeHtml(evidence[a]):'—';
        return `<tr><td>${areaLabel(a)}</td><td>${s}</td><td>${c}</td><td>${ev}</td></tr>`;
      }).join('');
    }
    function setGauge(val){
      $('#scoreText').textContent = val.toFixed(1);
      const t = (val>=8)?'hot':(val>=5)?'warm':'cold';
      $('#dot').className = 'dot ' + t;
      $('#tempText').textContent = (t==='hot'?'caldo':t==='warm'?'tiepido':'freddo');
      const deg = -90 + (Math.min(10,Math.max(0,val))/10)*180;
      $('#needle').style.transform = `rotate(${deg}deg)`;
      const L=377, shown=L*(Math.min(10,Math.max(0,val))/10);
      $('#arc').setAttribute('stroke-dasharray', `${shown} ${L-shown}`);
    }
    function overall(score){
      let sum=0, ws=0, reasons=[];
      for(const a of AREAS){ const s=score[a]??0; const w=WEIGHTS[a]??1; sum+=s*w; ws+=10*w; if(s>=7) reasons.push([areaLabel(a),s]); }
      reasons.sort((A,B)=>B[1]-A[1]);
      return { final: Math.round((sum/ws)*100)/10, reasons: reasons.slice(0,3).map(r=>r[0]) };
    }
    function proposeSlots(){ const d1=nextWorkingDay(new Date(),1); setTime(d1,11,30); const d2=nextWorkingDay(new Date(),2); setTime(d2,16,0); return [fmt(d1),fmt(d2)]; }
    function setTime(d,h,m){ d.setHours(h,m,0,0); } function nextWorkingDay(d,add){ const x=new Date(d); x.setDate(x.getDate()+add); const day=x.getDay(); if(day===6)x.setDate(x.getDate()+2); if(day===0)x.setDate(x.getDate()+1); return x; }
    function fmt(d){ const g=['dom','lun','mar','mer','gio','ven','sab']; return g[d.getDay()]+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
    function buildScript(name, reasons){ const slot=proposeSlots(); const why=reasons?.length?` In 15' ti mostro come passare da telefono occupato a calendario pieno: ${reasons.join(' · ')}.`:''; return `Ciao ${name||'—'}, seguo strutture come la tua per ridurre chiamate perse e aumentare appuntamenti integrando prenotazione online e gestione chiamate.${why} Ti propongo ${slot[0]} o ${slot[1]} su Meet. Quale preferisci?`; }

    async function fetchDirect(url){
      const res = await fetch(url, { credentials:'omit' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const html = await res.text();
      return { html };
    }
    async function fetchViaProxy(url){
      const endpoint = (state.proxyEndpoint||'').trim();
      if(!endpoint) throw new Error('Proxy non configurato');
      const res = await fetch(endpoint + encodeURIComponent(url), { credentials:'omit' });
      if(!res.ok) throw new Error('Proxy HTTP '+res.status);
      const data = await res.json();
      if(!data || !data.html) throw new Error('Risposta proxy non valida');
      return { html: data.html };
    }
    function extractText(html){
      try{ const doc = new DOMParser().parseFromString(html,'text/html'); doc.querySelectorAll('script,style,noscript,svg,nav,footer').forEach(n=>n.remove()); return (doc.body?.innerText||'').replace(/\s+/g,' ').trim(); }catch(e){ return html.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim(); }
    }
    function abs(base, href){ try{ return new URL(href, base).href; }catch{ return null; } }
    function pickLinks(base, html){
      const doc = new DOMParser().parseFromString(html,'text/html');
      const want = /(medici|equipe|staff|team|chi-siamo|servizi|prestazioni|contatti|prenota|booking)/i;
      const links = Array.from(doc.querySelectorAll('a[href]')).map(a=>a.getAttribute('href')).filter(Boolean);
      const out = []; for(const h of links){ if(want.test(h)){ const u = abs(base,h); if(u && !out.includes(u)) out.push(u); } }
      return out.slice(0,3);
    }

    async function analyzeFromUrl(){
      const urlInput = $('#url').value.trim();
      if(!urlInput){ alert('Inserisci un URL.'); return; }
      setStatus('Lettura pagina principale…'); setProgress(10);
      let base; try{ base = new URL(urlInput).origin; }catch{ alert('URL non valido'); return; }
      const texts = [];
      try{
        let main; if(state.forceProxy){ main = await fetchViaProxy(urlInput); } else {
          try{ main = await fetchDirect(urlInput); }catch(e){ setStatus('CORS bloccato: passo al proxy…'); main = await fetchViaProxy(urlInput); }
        }
        const mainText = extractText(main.html);
        texts.push({ url:urlInput, html:main.html, text:mainText });
        setStatus('Estrazione link interni…'); setProgress(40);
        const links = pickLinks(base, main.html);
        setStatus('Lettura sottopagine…'); setProgress(60);
        for(const l of links){
          try{
            let sub; if(state.forceProxy){ sub = await fetchViaProxy(l); } else {
              try{ sub = await fetchDirect(l); }catch{ sub = await fetchViaProxy(l); }
            }
            texts.push({ url:l, html:sub.html, text:extractText(sub.html) });
          }catch{ /* skip */ }
        }
        setStatus('Valutazione aree…'); setProgress(80);
        const { score, conf, evidence, coverage } = analyzeTexts(texts);
        renderAreas(score, conf, evidence);
        $('#coverage').textContent = 'Copertura segnali: ' + coverage + '%';
        const { final, reasons } = overall(score);
        setGauge(final);
        $('#script').value = buildScript($('#name').value, reasons);
        window.__lastAnalysis = { final, reasons };
        setStatus('Fatto.'); setProgress(100);
      }catch(err){
        console.error(err);
        setStatus('Impossibile leggere il sito. Configura un proxy in Impostazioni.');
        setProgress(0);
      }
    }

    async function analyzeFromPasted(){
      const t = $('#pasted').value.trim(); if(!t){ alert('Incolla del testo'); return; }
      setStatus('Analisi del testo incollato…'); setProgress(60);
      const { score, conf, evidence, coverage } = analyzeTexts([{url:'pasted://', html:'', text:t}]);
      renderAreas(score, conf, evidence);
      $('#coverage').textContent = 'Copertura segnali: ' + coverage + '%';
      const { final, reasons } = overall(score);
      setGauge(final);
      $('#script').value = buildScript($('#name').value, reasons);
      window.__lastAnalysis = { final, reasons };
      setStatus('Fatto.'); setProgress(100);
    }

    function temperature(v){ return (v>=8)?'hot':(v>=5)?'warm':'cold'; }
    function renderQueue(){
      const term = $('#search').value?.toLowerCase()||'';
      const leads = Settings.load().leads || [];
      state.leads = leads;
      const rows = leads.slice().sort((a,b)=> b.score - a.score || a.createdAt - b.createdAt)
        .filter(l => !term || (l.name.toLowerCase().includes(term) || (l.city||'').toLowerCase().includes(term)))
        .map(l => `<tr data-id="${l.id}">
          <td><span class="dot ${(l.temp||'cold')}"></span></td>
          <td>${escapeHtml(l.name)}</td>
          <td>${escapeHtml(l.city||'')}</td>
          <td>${l.score.toFixed(1)}</td>
          <td class="actions">
            <button data-act="wa">WA</button>
            <button data-act="call">Chiama</button>
            <button data-act="mail" class="btn-ghost">Email</button>
            <button data-act="del" class="btn-danger">Elimina</button>
          </td>
        </tr>`).join('');
      $('#queueBody').innerHTML = rows || `<tr><td colspan="5" class="muted">Nessun lead salvato.</td></tr>`;
    }
    function addToQueue(){
      const la = window.__lastAnalysis||{final:0,reasons:[]};
      const lead = {
        id: uuid(),
        name: $('#name').value.trim()||'—',
        city: $('#city').value.trim(),
        phone: $('#phone').value.trim(),
        url: $('#url').value.trim(),
        score: la.final,
        temp: temperature(la.final),
        reasons: la.reasons,
        script: $('#script').value.trim(),
        createdAt: Date.now()
      };
      const s = Settings.load(); s.leads = s.leads||[]; s.leads.push(lead); Settings.save(s); renderQueue();
      alert('Aggiunto in coda.');
    }
    function exportJSON(){ const s=Settings.load(); const blob=new Blob([JSON.stringify({leads:s.leads||[]},null,2)],{type:'application/json'}); download(blob,'qpwon_scoring_auto_proxy.json'); }
    function exportCSV(){
      const s=Settings.load(); const cols=['nome','città','url','telefono','score','temperatura','motivi'];
      const rows=(s.leads||[]).map(l=>[wrap(l.name),wrap(l.city||''),wrap(l.url||''),wrap(l.phone||''),l.score.toFixed(1),l.temp,wrap((l.reasons||[]).join(' | '))].join(','));
      const csv=[cols.join(','),...rows].join('\n'); download(new Blob([csv],{type:'text/csv;charset=utf-8;'}),'qpwon_scoring_auto_proxy.csv');
      function wrap(s){ s=(s||'').toString().replaceAll('"','""'); return '"'+s+'"'; }
    }
    function download(blob,filename){ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

    $('#btnSettings').addEventListener('click', ()=>{ $('#proxyEndpoint').value = state.proxyEndpoint||''; $('#forceProxy').checked = !!state.forceProxy; $('#dlg').showModal(); });
    $('#saveSettings').addEventListener('click', (e)=>{ e.preventDefault(); state.proxyEndpoint = $('#proxyEndpoint').value.trim(); state.forceProxy = $('#forceProxy').checked; Settings.save(state); $('#dlg').close(); alert('Impostazioni salvate.'); });

    $('#analyze').addEventListener('click', analyzeFromUrl);
    $('#analyzePasted').addEventListener('click', analyzeFromPasted);
    $('#saveQueue').addEventListener('click', addToQueue);
    $('#search').addEventListener('input', renderQueue);
    $('#exportJSON').addEventListener('click', exportJSON);
    $('#exportCSV').addEventListener('click', exportCSV);
    $('#importJSON').addEventListener('change', async (e)=>{
      const f=e.target.files[0]; if(!f) return;
      try{ const t=await f.text(); const data=JSON.parse(t); if(data && Array.isArray(data.leads)){ const s=Settings.load(); s.leads=data.leads; Settings.save(s); renderQueue(); alert('Import completato.'); } else { alert('File non valido.'); } }catch(err){ alert('Errore import: '+err.message); }
      e.target.value='';
    });
    $('#resetAll').addEventListener('click', ()=>{ if(confirm('Eliminare tutti i lead e le impostazioni?')){ state={proxyEndpoint:'',forceProxy:false,leads:[]}; Settings.save(state); renderQueue(); }});

    renderQueue(); setGauge(0);
  </script>
</body>
</html>
