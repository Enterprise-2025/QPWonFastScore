<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QPWON – Scoring Sprint (Auto‑Analyzer · CONFIG)</title>
  <meta name="description" content="Versione pulita e preconfigurata. Inserisci l’URL del centro: analisi automatica con proxy, niente dipendenze." />
  <style>
    :root {
      --bg:#0f1220; --card:#1b2140; --muted:#9ab0d6; --text:#e7ecff;
      --good:#2ecc71; --warn:#f1c40f; --cold:#4aa3ff; --accent:#7c5cff; --danger:#ff6b6b;
      --b:#283060; --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box} html,body{height:100%} body{
      margin:0;background:linear-gradient(120deg,#0e1324,#0a0f1d);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    }
    a{color:var(--accent)}
    header{position:sticky;top:0;z-index:10;background:rgba(10,15,29,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2648}
    .topbar{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .brand{font-weight:700} .pill{padding:6px 10px;border:1px solid #2a3260;border-radius:999px;color:var(--muted);font-size:12px}}
    button{appearance:none;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;background:#202955;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
    button.btn-accent{background:var(--accent);border-color:#543cff} button.btn-ghost{background:transparent} button.btn-danger{background:var(--danger);border-color:#ff6b6b}
    input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #33407a;background:#0f1532;color:#e7ecff;outline:none}
    main{padding:18px;display:grid;gap:18px;grid-template-columns:1.25fr 1fr 1.1fr}
    @media (max-width:1200px){ main{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,#1a2145,#12183a);border:1px solid var(--b);border-radius:var(--r);box-shadow:var(--shadow)}
    .card>h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--b);font-size:16px;color:#cdd9ff}
    .content{padding:14px 16px} .row{display:flex;gap:10px;align-items:center} .col{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)} .spacer{flex:1}
    .progress{height:8px;border:1px solid #25305b;border-radius:999px;overflow:hidden;background:#0d1430} .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),#5c87ff);width:0%}

    .gauge-wrap{display:flex;align-items:center;justify-content:center;padding:8px 0}
    .gauge{width:260px;height:150px} .needle{transform-origin:130px 130px;transition:transform .4s ease}
    .score-big{font-size:44px;font-weight:800;text-align:center;margin-top:-4px}
    .band{display:flex;gap:8px;justify-content:center} .dot{width:12px;height:12px;border-radius:50%}
    .dot.cold{background:var(--cold)} .dot.warm{background:var(--warn)} .dot.hot{background:var(--good)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:13px;padding:8px 10px;text-align:left} thead th{color:#cfe1ff}
    tbody tr{background:#11173a;border:1px solid var(--b)} tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px} tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:2px 6px;border:1px solid #33407a;border-radius:999px;font-size:11px;color:#cfe1ff}
    .conf-low{background:#231a3d} .conf-mid{background:#1b2a55} .conf-high{background:#173a2d}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">QPWON · <span class="muted">Scoring Sprint</span></div>
      <span class="pill">Auto‑Analyzer · Configurato</span>
      <div class="spacer"></div>
      <button id="btnSettings" class="btn-ghost">Impostazioni</button>
      <button id="exportJSON" class="btn-ghost">Export JSON</button>
      <button id="exportCSV" class="btn-ghost">Export CSV</button>
      <button id="reset" class="btn-danger">Reset</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>1) URL → Analisi automatica</h2>
      <div class="content col">
        <div class="row">
          <input id="url" type="url" placeholder="Incolla l'URL (es. https://www.polixyz.it)" />
          <button id="analyze" class="btn-accent">Analizza</button>
        </div>
        <div class="progress"><div id="pbar"></div></div>
        <div id="status" class="muted">Pronto.</div>
      </div>
    </section>

    <section class="card">
      <h2>2) Score complessivo & aree</h2>
      <div class="content col">
        <div class="gauge-wrap">
          <div class="gauge">
            <svg viewBox="0 0 260 150" xmlns="http://www.w3.org/2000/svg" aria-label="Gauge">
              <defs>
                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--cold)"/>
                  <stop offset="50%" stop-color="var(--warn)"/>
                  <stop offset="100%" stop-color="var(--good)"/>
                </linearGradient>
              </defs>
              <path d="M 20 130 A 110 110 0 0 1 240 130" fill="none" stroke="#23305e" stroke-width="14" stroke-linecap="round"/>
              <path id="arc" d="M 20 130 A 110 110 0 0 1 240 130" fill="none" stroke="url(#grad)" stroke-width="14" stroke-linecap="round" stroke-dasharray="0 345"/>
              <g id="needle" class="needle">
                <line x1="130" y1="130" x2="130" y2="38" stroke="#e7ecff" stroke-width="4"/>
                <circle cx="130" cy="130" r="6" fill="#e7ecff"/>
              </g>
            </svg>
          </div>
        </div>
        <div class="score-big" id="scoreText">0.0</div>
        <div class="band"><span>Pallino:</span> <span id="dot" class="dot cold"></span> <span id="tempText" class="muted">freddo</span></div>
        <div class="muted" id="coverage">Copertura segnali: 0%</div>

        <table>
          <thead>
            <tr><th>Area</th><th>Score</th><th>Confidenza</th><th>Evidenza</th></tr>
          </thead>
          <tbody id="areasBody"></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>3) Script & coda</h2>
      <div class="content col">
        <label>Nome struttura</label><input id="name" type="text" placeholder="Es. Poliambulatorio XYZ" />
        <label>Città</label><input id="city" type="text" placeholder="Es. Bologna" />
        <label>Telefono</label><input id="phone" type="tel" placeholder="+39…" />
        <label>Script (WhatsApp / Email)</label><textarea id="script" placeholder="Verrà generato automaticamente…"></textarea>

        <div class="row">
          <button id="saveLead" class="btn-accent">Salva & metti in coda</button>
          <input id="search" type="text" placeholder="Cerca nella coda… (nome, città)" />
        </div>

        <table>
          <thead><tr><th>Priorità</th><th>Struttura</th><th>Città</th><th>Score</th><th>Azioni</th></tr></thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Impostazioni -->
  <dialog id="dlg">
    <form method="dialog" style="min-width:min(640px,95vw);background:#0e1430;border:1px solid #2a3260;color:#e7ecff;border-radius:14px;padding:14px">
      <h3 style="margin:0 0 8px 0">Impostazioni</h3>
      <div style="display:grid;gap:10px">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="forceProxy"/> Forza uso proxy (consigliato)
        </label>
        <div>
          <label>Endpoint Proxy</label>
          <input id="proxyEndpoint" type="url" placeholder="https://.../?url=" />
          <div class="muted">Preconfigurato: https://qpwonscorepro.apesce-consulente.workers.dev/?url=</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button value="cancel" class="btn-ghost">Chiudi</button>
        <button id="saveSettings" class="btn-accent">Salva</button>
      </div>
    </form>
  </dialog>

  <script>
    // ================== Helpers & State ==================
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const STORAGE = 'qpwon_scoring_config_clean_v1';
    const DEFAULTS = { proxyEndpoint: "https://qpwonscorepro.apesce-consulente.workers.dev/?url=", forceProxy: true, leads: [] };

    const S = {
      load() { try { return JSON.parse(localStorage.getItem(STORAGE)) || DEFAULTS; } catch { return DEFAULTS; } },
      save(v) { localStorage.setItem(STORAGE, JSON.stringify(v)); }
    };
    let state = S.load();

    const AREAS = ['booking','telefonate','orari','whatsapp','crescita','doppioSistema','dimensione','serviziCall','decisionMaker','numeroDiretto'];
    const WEIGHTS = { booking:2, telefonate:2, orari:1, whatsapp:1, crescita:2, doppioSistema:2, dimensione:2, serviziCall:1, decisionMaker:1, numeroDiretto:1 };

    const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    function setStatus(t) { $('#status').textContent = t; }
    function setProgress(p) { $('#pbar').style.width = p + '%'; }
    function clamp(n, a, b) { return Math.min(b, Math.max(a, n)); }
    function uuid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    // ================== Proxy Fetch ==================
    async function fetchViaProxy(url) {
      const ep = (state.proxyEndpoint || DEFAULTS.proxyEndpoint).trim();
      const r = await fetch(ep + encodeURIComponent(url), { credentials:'omit' });
      if (!r.ok) throw new Error('Proxy HTTP ' + r.status);
      const data = await r.json();
      if (!data || !data.html) throw new Error('Risposta proxy non valida');
      return { html: data.html };
    }
    function extractText(html) {
      try {
        const doc = new DOMParser().parseFromString(html,'text/html');
        doc.querySelectorAll('script,style,noscript,svg,nav,footer').forEach(n=>n.remove());
        return (doc.body?.innerText || '').replace(/\s+/g,' ').trim();
      } catch (e) {
        return html.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
      }
    }
    function abs(base, href) { try { return new URL(href, base).href; } catch { return null; } }
    function pickLinks(base, html) {
      const doc = new DOMParser().parseFromString(html,'text/html');
      const want = /(medici|equipe|staff|team|chi-siamo|servizi|prestazioni|contatti|prenota|booking)/i;
      const links = Array.from(doc.querySelectorAll('a[href]')).map(a => a.getAttribute('href')).filter(Boolean);
      const out = [];
      for (const h of links) { if (want.test(h)) { const u = abs(base, h); if (u && !out.includes(u)) out.push(u); } }
      return out.slice(0,3);
    }

    // ================== Heuristics ==================
    function analyzeTexts(texts) {
      const concat = texts.map(t => (t.text||'') + ' ').join(' ').toLowerCase();
      const score = {}, conf = {}, ev = {};

      const md = /miodottore/.test(concat), dl = /doctolib/.test(concat), book = /(prenota|prenotazione|booking|appuntamenti)/.test(concat);
      if (!book) { score.booking=10; conf.booking='mid'; ev.booking='Nessuna traccia di prenotazione online'; }
      else if (md && dl) { score.booking=7; conf.booking='high'; ev.booking='MD+DL entrambi presenti'; }
      else if (md || dl) { score.booking=6; conf.booking='high'; ev.booking='Portale esterno rilevato'; }
      else { score.booking=5; conf.booking='mid'; ev.booking='Prenotazione presente ma potenzialmente confusa'; }

      const telRe = /(linee occupate|sempre occupato|attesa|richiama|solo telefono|chiamare per prenotare)/;
      score.telefonate = telRe.test(concat) ? 8 : (book ? 3 : 7);
      conf.telefonate = telRe.test(concat) ? 'mid' : 'low';
      ev.telefonate = telRe.test(concat) ? 'Testo con attese/telefono' : 'Indizio indiretto';

      const hasSat = /(sab|sabato)/.test(concat);
      const times = concat.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/g) || [];
      const late = times.some(t => { const [h,m]=t.split(':').map(Number); return h>19 || (h===19 && m>=30); });
      score.orari = (hasSat||late)?8:3; conf.orari=(hasSat||late)?'mid':'low'; ev.orari=(hasSat?'sabato ':'')+(late?'orari ≥19:30':'');

      const wa = /(wa\.me|api\.whatsapp|whatsapp)/.test(concat);
      score.whatsapp = wa?7:2; conf.whatsapp=wa?'high':'low'; ev.whatsapp = wa?'Link/menzione WhatsApp':'Nessuna evidenza';

      const gr = /(nuova sede|apertura|stiamo assumendo|lavora con noi|apre|nuovo centro|nuovi macchinari|campagna|promozione)/.test(concat);
      score.crescita = gr?8:3; conf.crescita=gr?'mid':'low'; ev.crescita = gr?'Parole chiave di crescita':'Nessuna evidenza';

      if (md && dl) { score.doppioSistema=9; conf.doppioSistema='high'; ev.doppioSistema='MD+DL rilevati'; }
      else { score.doppioSistema=2; conf.doppioSistema='mid'; ev.doppioSistema='Nessun doppio sistema chiaro'; }

      const medRe = /(dott\.|dottore|dottoressa|dr\.|medico|specialista)/g;
      const hits = (concat.match(medRe)||[]).length;
      score.dimensione = (hits>=3 && hits<=20)?9 : (hits>20 && hits<=40)?6 : (hits>40)?5 : 3;
      conf.dimensione = 'low'; ev.dimensione = 'Occorrenze parole-medico: ' + hits;

      const hi = /(prelievi|analisi|fisioterapia|oculistica|ecografia|radiologia|tac|risonanza)/.test(concat);
      score.serviziCall = hi?7:3; conf.serviziCall=hi?'mid':'low'; ev.serviziCall = hi?'Servizi ad alta chiamata presenti':'Nessuna evidenza';

      const hasPh = /((\+?39\s?)?0?\d[\d\s\-\.]{6,})/.test(concat);
      const pre = /(prenotazioni|segreteria|cup|centralino|accettazione)/.test(concat);
      score.numeroDiretto = hasPh ? (pre?7:5) : 2; conf.numeroDiretto = hasPh?'mid':'low'; ev.numeroDiretto = hasPh?'Telefono presente':'Nessuna evidenza';

      const coverage = Math.round(100 * (Object.keys(score).length / AREAS.length));
      return { score, conf, ev, coverage };
    }

    function areaLabel(k) {
      return ({booking:'Prenotazione online migliorabile/assente',telefonate:'Traffico telefonico/attese',orari:'Orari estesi/sabato (alto afflusso)',whatsapp:'WhatsApp presente (rischio non presidiato)',crescita:'Segnali di crescita (sede/assunzioni/adv)',doppioSistema:'Doppio sistema MD+DL',dimensione:'Taglia 3–20 medici (stimata)',serviziCall:'Servizi ad alta chiamata presenti',decisionMaker:'Decision maker identificabile',numeroDiretto:'Numero diretto/centralino rilevato'})[k] || k;
    }
    function confBadge(c) {
      const map = {low:'conf-low',mid:'conf-mid',high:'conf-high'};
      return '<span class="badge ' + (map[c]||'conf-low') + '">' + (c||'low') + '</span>';
    }
    function renderAreas(score, conf, ev) {
      $('#areasBody').innerHTML = AREAS.map(a => {
        const s = (score[a]??0).toFixed(1);
        const c = confBadge(conf[a]);
        const e = ev[a] ? esc(ev[a]) : '—';
        return '<tr><td>'+areaLabel(a)+'</td><td>'+s+'</td><td>'+c+'</td><td>'+e+'</td></tr>';
      }).join('');
    }
    function overall(score) {
      let sum=0, ws=0, rs=[];
      for (const a of AREAS) { const s=score[a]??0, w=WEIGHTS[a]??1; sum+=s*w; ws+=10*w; if(s>=7) rs.push([areaLabel(a), s]); }
      rs.sort((A,B)=>B[1]-A[1]);
      return { final: Math.round((sum/ws)*100)/10, reasons: rs.slice(0,3).map(r=>r[0]) };
    }
    function setGauge(v) {
      $('#scoreText').textContent = v.toFixed(1);
      const t = v>=8?'hot':v>=5?'warm':'cold';
      $('#dot').className = 'dot ' + t;
      $('#tempText').textContent = (t==='hot'?'caldo':t==='warm'?'tiepido':'freddo');
      const L=345, shown=L*(Math.min(10,Math.max(0,v))/10);
      $('#arc').setAttribute('stroke-dasharray', shown+' '+(L-shown));
      const deg = -90 + (Math.min(10,Math.max(0,v))/10)*180;
      $('#needle').style.transform = 'rotate('+deg+'deg)';
    }
    function proposeSlots() {
      const d1=new Date(); d1.setDate(d1.getDate()+1); d1.setHours(11,30,0,0);
      const d2=new Date(); d2.setDate(d2.getDate()+2); d2.setHours(16,0,0,0);
      const g=['dom','lun','mar','mer','gio','ven','sab'];
      const f=d=>g[d.getDay()]+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');
      return [f(d1), f(d2)];
    }
    function buildScript(name, reasons) {
      const [a,b] = proposeSlots();
      const why = reasons?.length ? " In 15' ti mostro: " + reasons.join(' · ') + "." : "";
      return "Ciao " + (name||'—') + ", seguo strutture come la tua per ridurre chiamate perse e aumentare appuntamenti integrando prenotazione online e gestione chiamate." + why + " Ti propongo " + a + " o " + b + " su Meet. Quale preferisci?";
    }

    // ================== Analyze ==================
    async function analyzeFromUrl() {
      const url = $('#url').value.trim(); if(!url) { alert('Inserisci un URL'); return; }
      setStatus('Lettura pagina…'); setProgress(10);
      let base; try { base = new URL(url).origin; } catch { alert('URL non valido'); return; }
      const texts = [];
      try {
        const main = await fetchViaProxy(url);
        const mt = extractText(main.html);
        texts.push({ url, text: mt });
        setStatus('Estrazione link interni…'); setProgress(40);
        const links = pickLinks(base, main.html);
        setStatus('Lettura sottopagine…'); setProgress(60);
        for (const l of links) {
          try { const sub = await fetchViaProxy(l); texts.push({ url:l, text: extractText(sub.html) }); } catch {}
        }
        setStatus('Valutazione aree…'); setProgress(80);
        const { score, conf, ev, coverage } = analyzeTexts(texts);
        renderAreas(score, conf, ev);
        $('#coverage').textContent = 'Copertura segnali: ' + coverage + '%';
        const o = overall(score); setGauge(o.final);
        $('#script').value = buildScript($('#name').value, o.reasons);
        window.__lastAnalysis = o;
        setStatus('Fatto.'); setProgress(100);
      } catch (e) {
        console.error(e); setStatus('Errore proxy: ' + e.message); setProgress(0);
      }
    }

    // ================== Queue & Export ==================
    function temperature(v) { return v>=8?'hot':v>=5?'warm':'cold'; }
    function renderQueue() {
      const term = $('#search')?.value?.toLowerCase()||'';
      const leads = (S.load().leads||[]).slice().sort((a,b)=>b.score-a.score||a.createdAt-b.createdAt)
        .filter(l => !term || l.name.toLowerCase().includes(term) || (l.city||'').toLowerCase().includes(term));
      $('#queueBody').innerHTML = leads.map(l => (
        '<tr><td><span class="dot '+(l.temp||'cold')+'"></span></td><td>'+esc(l.name)+'</td><td>'+esc(l.city||'')+'</td><td>'+l.score.toFixed(1)+'</td><td><button onclick="alert(\'Chiama: \' + (l.phone||\'\'))">Chiama</button></td></tr>'
      )).join('') || '<tr><td colspan="5" class="muted">Nessun lead salvato.</td></tr>';
    }
    function addLead() {
      const o = window.__lastAnalysis || { final:0, reasons:[] };
      const s = S.load(); s.leads = s.leads || [];
      s.leads.push({
        id: Math.random().toString(36).slice(2),
        name: $('#name').value.trim()||'—',
        city: $('#city').value.trim(),
        phone: $('#phone').value.trim(),
        url: $('#url').value.trim(),
        score: o.final, temp: (o.final>=8?'hot':o.final>=5?'warm':'cold'),
        reasons: o.reasons, script: $('#script').value.trim(),
        createdAt: Date.now()
      });
      S.save(s); renderQueue(); alert('Aggiunto in coda.');
    }
    function exportJSON() { const s=S.load(); const blob=new Blob([JSON.stringify({leads:s.leads||[]},null,2)],{type:'application/json'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='qpwon_scoring_export.json'; a.click(); URL.revokeObjectURL(u); }
    function exportCSV() {
      const s=S.load(); const cols=['nome','città','url','telefono','score','temperatura','motivi'];
      const rows=(s.leads||[]).map(l=>[wrap(l.name),wrap(l.city||''),wrap(l.url||''),wrap(l.phone||''),l.score.toFixed(1),l.temp,wrap((l.reasons||[]).join(' | '))].join(','));
      const csv=[cols.join(','),...rows].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='qpwon_scoring_export.csv'; a.click(); URL.revokeObjectURL(u);
      function wrap(s){ s=(s||'').toString().replaceAll('"','""'); return '"'+s+'"'; }
    }

    // ================== UI Bindings ==================
    $('#analyze').addEventListener('click', analyzeFromUrl);
    $('#saveLead').addEventListener('click', addLead);
    $('#exportJSON').addEventListener('click', exportJSON);
    $('#exportCSV').addEventListener('click', exportCSV);
    $('#reset').addEventListener('click', ()=>{ if(confirm('Reset impostazioni + coda?')){ localStorage.removeItem(STORAGE); state=S.load(); renderQueue(); } });

    $('#btnSettings').addEventListener('click', ()=>{ $('#proxyEndpoint').value = (S.load().proxyEndpoint || DEFAULTS.proxyEndpoint); $('#forceProxy').checked = true; $('#dlg').showModal(); });
    $('#saveSettings').addEventListener('click', (e)=>{ e.preventDefault(); const s=S.load(); s.proxyEndpoint=$('#proxyEndpoint').value.trim()||DEFAULTS.proxyEndpoint; s.forceProxy=$('#forceProxy').checked; S.save(s); $('#dlg').close(); alert('Impostazioni salvate.'); });

    // Init
    renderQueue();
    setGauge(0);
  </script>
</body>
</html>
