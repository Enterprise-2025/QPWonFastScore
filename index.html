<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QPWON ¬∑ Scoring Sprint (v1.7)</title>
  <meta name="description" content="Analisi rapida per poliambulatori: score, top 5 debolezze, staff medico, contatti prioritari, advisor, multisede, debug. Nessuna dipendenza." />
  <style>
    :root{
      --bg:#0f1220; --bg2:#121735; --card:#1b2140; --surface:#161c39; --line:#283060;
      --text:#e7ecff; --muted:#9fb3db;
      --accent:#7c5cff; --accent-2:#5c87ff;
      --good:#2ecc71; --warn:#f1c40f; --cold:#4aa3ff; --danger:#ff6b6b;
      --shadow:0 8px 24px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(120deg,#0e1324,#0a0f1d); color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-feature-settings:"tnum" 1, "cv05" 1;
    }
    a{color:var(--accent)}
    header{position:sticky;top:0;z-index:15;background:rgba(10,15,29,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2648}
    .topbar{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .brand{font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .spacer{flex:1}
    .pill{padding:6px 10px;border:1px solid #2a3260;border-radius:999px;color:var(--muted);font-size:12px}
    button{appearance:none;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;background:#202955;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
    button.btn-accent{background:var(--accent);border-color:#543cff}
    button.btn-ghost{background:transparent}
    button.btn-danger{background:var(--danger);border-color:#ff6b6b}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #33407a;background:#0f1532;color:#e7ecff;outline:none}
    textarea{min-height:110px;resize:vertical}
    main{padding:18px;display:grid;gap:18px;grid-template-columns:1.15fr 1.35fr 1.1fr}
    @media (max-width:1200px){ main{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,#1a2145,#12183a);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card>h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;color:#cdd9ff;display:flex;align-items:center;gap:8px}
    .content{padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center}
    .col{display:flex;flex-direction:column;gap:10px}
    .progress{height:8px;border:1px solid #25305b;border-radius:999px;overflow:hidden;background:#0d1430}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}
    .gauge-wrap{display:flex;align-items:center;justify-content:center;padding:6px 0}
    .gauge{width:280px;height:160px}
    .needle{transform-origin:140px 140px;transition:transform .4s ease}
    .score-big{font-size:48px;font-weight:800;text-align:center;margin-top:0}
    .band{display:flex;gap:8px;justify-content:center;align-items:center}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.cold{background:var(--cold)} .dot.warm{background:var(--warn)} .dot.hot{background:var(--good)}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid #31407a;border-radius:999px;background:#141a3a;font-size:13px;margin:4px 6px 0 0}
    .chip strong{font-weight:700}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:13px;padding:8px 10px;text-align:left} thead th{color:#cfe1ff}
    tbody tr{background:#11173a;border:1px solid var(--line)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:2px 6px;border:1px solid #33407a;border-radius:999px;font-size:11px;color:#cfe1ff}
    .conf-low{background:#231a3d} .conf-mid{background:#1b2a55} .conf-high{background:#173a2d} .conf-guess{background:#3a2f17;border-color:#6a5110}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kpi .box{background:#0f1532;border:1px solid #2a3260;border-radius:12px;padding:10px}
    .top5{display:flex;flex-wrap:wrap;gap:8px}
    .toast{position:fixed;right:16px;top:66px;background:#1b2140;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;box-shadow:var(--shadow);opacity:0;transform:translateY(-6px);transition:all .2s ease;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    .debug-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .dbgbox{background:#0e1535;border:1px dashed #33407a;border-radius:12px;padding:10px}
    .dbgbox h4{margin:0 0 6px 0;color:#cfe1ff}
    .snip{font-size:12px;color:#cfe1ff;background:#0b1230;border:1px solid #2a3260;border-radius:8px;padding:8px;white-space:pre-wrap}
    .tag{font-size:11px;border:1px solid #31407a;background:#141a3a;border-radius:999px;padding:2px 6px;color:#cfe1ff;margin-left:6px}
    dialog{border:none;border-radius:14px;padding:0;max-width:min(820px,95vw)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dlg-body{background:#0e1430;border:1px solid #2a3260;color:#e7ecff;border-radius:14px;padding:14px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #2a3260;padding:8px 6px;font-size:13px;text-align:left}
    .advisor{min-height:130px}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">QPWON ¬∑ <span class="muted">Scoring Sprint</span></div>
    <span class="pill">v1.7 ¬∑ no deps</span>
    <div class="spacer"></div>
    <button id="btnSettings" class="btn-ghost">Impostazioni</button>
    <button id="exportJSON" class="btn-ghost">Export JSON</button>
    <button id="exportCSV" class="btn-ghost">Export CSV</button>
    <button id="resetAll" class="btn-danger">Reset</button>
  </div>
</header>

<main>
  <!-- Col A -->
  <section class="card">
    <h2>1) URL ‚Üí Analisi automatica</h2>
    <div class="content col">
      <div class="row">
        <input id="url" type="url" placeholder="Incolla l'URL (es. https://www.polixyz.it)" />
        <button id="analyze" class="btn-accent">Analizza</button>
      </div>
      <div class="progress"><div id="pbar"></div></div>
      <div id="status" class="muted">Pronto.</div>

      <details style="margin-top:6px">
        <summary class="muted">Problemi di lettura? (Siti solo JS) ‚Ä¢ Incolla testo</summary>
        <textarea id="pasted" placeholder="Incolla qui il testo della pagina e poi premi Analizza"></textarea>
      </details>

      <details style="margin-top:8px">
        <summary class="muted">Provenienza pagine (debug)</summary>
        <div id="prov" class="kpi" style="margin-top:8px"></div>
      </details>

      <details style="margin-top:8px">
        <summary class="muted">Debugger: Footer/Contatti, Staff, Booking</summary>
        <div class="debug-grid" style="margin-top:8px">
          <div class="dbgbox">
            <h4>Contatti trovati <span class="tag" id="dbgContactsCount">0</span></h4>
            <div id="dbgContacts"></div>
          </div>
          <div class="dbgbox">
            <h4>Blocchi Footer/Contatti <span class="tag" id="dbgBlocksCount">0</span></h4>
            <div id="dbgBlocks"></div>
          </div>
          <div class="dbgbox">
            <h4>Staff Finder <span class="tag" id="dbgStaffCount">0</span></h4>
            <div id="dbgStaff"></div>
          </div>
          <div class="dbgbox" style="grid-column:1/3">
            <h4>Prenotazione: provider/script/JSON-LD/form/CTA <span class="tag" id="dbgBookingCount">0</span></h4>
            <div id="dbgBooking"></div>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- Col B -->
  <section class="card">
    <h2>2) Score, Staff, Aree & Advisor</h2>
    <div class="content col">
      <div class="gauge-wrap">
        <div class="gauge">
          <svg viewBox="0 0 280 160" xmlns="http://www.w3.org/2000/svg" aria-label="Gauge">
            <defs>
              <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="var(--cold)"/>
                <stop offset="50%" stop-color="var(--warn)"/>
                <stop offset="100%" stop-color="var(--good)"/>
              </linearGradient>
            </defs>
            <path d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="#23305e" stroke-width="14" stroke-linecap="round"/>
            <path id="arc" d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="url(#grad)" stroke-width="14" stroke-linecap="round" stroke-dasharray="0 377"/>
            <g id="needle" class="needle">
              <line x1="140" y1="140" x2="140" y2="42" stroke="#e7ecff" stroke-width="4"/>
              <circle cx="140" cy="140" r="6" fill="#e7ecff"/>
            </g>
          </svg>
        </div>
      </div>
      <div class="score-big" id="scoreText">0.0</div>
      <div class="band"><span>Pallino:</span> <span id="dot" class="dot cold"></span> <span id="tempText" class="muted">freddo</span></div>
      <div class="muted" id="coverage">Copertura segnali: 0%</div>

      <div style="margin-top:8px">
        <div class="row" style="align-items:center;gap:8px">
          <strong>üë©‚Äç‚öïÔ∏è Staff medico stimato:</strong> <span id="staffBadge" class="badge conf-low">0 (low)</span>
          <button id="btnStaff" class="btn-ghost" style="margin-left:6px">Vedi elenco</button>
        </div>
      </div>

      <div style="margin-top:8px">
        <div class="row" style="align-items:center;gap:8px">
          <strong>üîé 5 punti deboli principali</strong>
        </div>
        <div id="top5" class="top5" style="margin-top:6px"></div>
      </div>

      <table style="margin-top:10px">
        <thead>
          <tr><th>Area</th><th>Score</th><th>Confidenza</th><th>Evidenza</th></tr>
        </thead>
        <tbody id="areasBody"></tbody>
      </table>

      <details style="margin-top:8px" open>
        <summary class="muted">üß† Commento consulenziale (Advisor)</summary>
        <textarea id="advisor" class="advisor" placeholder="Il commento verr√† generato automaticamente‚Ä¶"></textarea>
        <div class="row" style="gap:10px">
          <button id="copyAdvisor" class="btn-ghost">Copia commento</button>
          <button id="useAdvisorInPitch" class="btn-ghost">Inserisci nel pitch</button>
        </div>
      </details>
    </div>
  </section>

  <!-- Col C -->
  <section class="card">
    <h2>3) Contatti, Script & Coda</h2>
    <div class="content col">

      <div id="multiWrap" class="row" style="justify-content:space-between;gap:10px">
        <div class="row" style="gap:8px"><strong>Sede:</strong><span id="sedeLabel" class="muted">‚Äî</span></div>
        <div class="row" style="gap:6px">
          <button id="prevLoc" class="btn-ghost">‚óÄ</button>
          <select id="locSelect" style="min-width:240px"></select>
          <button id="nextLoc" class="btn-ghost">‚ñ∂</button>
        </div>
      </div>

      <div class="kpi" style="margin-top:8px">
        <div class="box">
          <label>Nome</label><input id="name" type="text" placeholder="Es. Poliambulatorio XYZ" />
        </div>
        <div class="box">
          <label>Citt√†</label><input id="city" type="text" placeholder="Es. Bologna" />
        </div>
        <div class="box">
          <label>Telefono</label><input id="phone" type="tel" placeholder="+39‚Ä¶" />
        </div>
        <div class="box">
          <label>Email</label><input id="email" type="email" placeholder="esempio@dominio.it" />
        </div>
        <div class="box" style="grid-column:1/2">
          <label>Indirizzo</label><input id="address" type="text" placeholder="Via‚Ä¶, CAP‚Ä¶, Citt√†‚Ä¶" />
        </div>
        <div class="box" style="grid-column:2/3">
          <label>Sorgente</label><input id="sourceHint" type="text" placeholder="mailto / cloudflare / block / jsonld‚Ä¶" disabled />
        </div>
      </div>

      <div class="row" style="margin-top:4px;gap:8px">
        <span id="confName"    class="badge conf-low">name: low</span>
        <span id="confCity"    class="badge conf-low">city: low</span>
        <span id="confPhone"   class="badge conf-low">phone: low</span>
        <span id="confEmail"   class="badge conf-low">email: low</span>
        <span id="confAddress" class="badge conf-low">address: low</span>
      </div>

      <div style="margin-top:10px">
        <div class="row" style="gap:12px">
          <button id="btnCopyContacts" class="btn-ghost">Copia contatti</button>
          <button id="btnOpenWA" class="btn-ghost">WhatsApp</button>
          <button id="btnMailto" class="btn-ghost">Email</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="row" style="gap:12px">
          <button id="tabScript" class="btn-accent">Script</button>
          <button id="tabPitch" class="btn-ghost">Pitch mail</button>
        </div>
        <div id="scriptWrap" class="col" style="margin-top:8px">
          <label>Script (WhatsApp / Call)</label>
          <textarea id="script" placeholder="Verr√† generato automaticamente‚Ä¶"></textarea>
        </div>
        <div id="pitchWrap" class="col" style="display:none;margin-top:8px">
          <label>Oggetto</label><input id="mailSubj" type="text" />
          <label>Corpo mail</label><textarea id="mailBody"></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveLead" class="btn-accent">Salva & metti in coda</button>
        <input id="search" type="text" placeholder="Cerca nella coda‚Ä¶ (nome, citt√†)" />
      </div>

      <table style="margin-top:6px">
        <thead><tr><th>Priorit√†</th><th>Struttura</th><th>Citt√†</th><th>Score</th><th>Azioni</th></tr></thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Impostazioni -->
<dialog id="dlg">
  <form method="dialog" class="dlg-body">
    <h3 style="margin:0 0 8px 0">Impostazioni</h3>
    <div style="display:grid;gap:10px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="resetAfterSave" checked/> Reset automatico dopo salvataggio
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="allowGuesses" checked/> Permetti 'guess' per telefono/email se non trovati
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="forceUADesktop" checked/> Forza UA desktop (maggior compatibilit√†)
      </label>
      <div>
        <label>Modalit√† Accuratezza</label>
        <select id="accuracyMode">
          <option value="balanced">Bilanciata (consigliata)</option>
          <option value="fast">Veloce</option>
          <option value="deep">Approfondita</option>
        </select>
        <div class="muted">Controlla profondit√† e budget del crawler (link visitati).</div>
      </div>
      <div>
        <label>Endpoint Proxy</label>
        <input id="proxyEndpoint" type="url" placeholder="https://.../?url=" />
        <div class="muted">Default: https://qpwonscorepro.apesce-consulente.workers.dev/?url=</div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button value="cancel" class="btn-ghost">Chiudi</button>
      <button id="saveSettings" class="btn-accent">Salva</button>
    </div>
  </form>
</dialog>

<!-- Staff dialog -->
<dialog id="dlgStaff">
  <div class="dlg-body">
    <h3 style="margin:0 0 8px 0">Elenco staff medico</h3>
    <div id="staffConf" class="muted" style="margin-bottom:8px">Confidenza: ‚Äî</div>
    <div style="max-height:min(55vh,520px);overflow:auto;border:1px solid #2a3260;border-radius:12px">
      <table class="table" id="tblStaff">
        <thead><tr><th>Nome</th><th>Ruolo/Specialit√†</th><th>Fonte</th><th>Pagina</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button onclick="document.getElementById('dlgStaff').close()" class="btn-accent">Chiudi</button>
    </div>
  </div>
</dialog>

<div id="toast" class="toast">Azione completata.</div>

<script>
/* =====================================================
   QPWON Scoring Sprint ‚Äî index.html (v1.7) ‚Äî No deps
   Novit√†:
   - Advisor: commento consulenziale auto
   - Crawler Priority-BFS (accuratezza: veloce/bilanciata/approfondita)
   - Contatti potenziati (HTML entities, base64/atob, JS vars)
   - Booking detection ampliata (form/CTA/JSON-LD ReserveAction)
   - Staff Finder rifinito
===================================================== */

const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

const STORAGE = 'qpwon_scoring_v1_7';
const DEFAULTS = {
  proxyEndpoint: "https://qpwonscorepro.apesce-consulente.workers.dev/?url=",
  resetAfterSave: true,
  allowGuesses: true,
  forceUADesktop: true,
  accuracyMode: "balanced", // fast, balanced, deep
  leads: []
};
const S = { load(){ try{ return JSON.parse(localStorage.getItem(STORAGE))||{...DEFAULTS}; }catch{ return {...DEFAULTS}; } },
            save(v){ localStorage.setItem(STORAGE, JSON.stringify(v)); } };
let state = S.load();

function toast(t){ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"), 2200); }
function setStatus(t){ $('#status').textContent = t; }
function setProgress(p){ $('#pbar').style.width = p+'%'; }
function esc(s){ return (s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function clamp(n,a,b){ return Math.min(b, Math.max(a,n)); }
function by(arr, key){ return (arr||[]).map(x=>x?.[key]).filter(Boolean); }

// ---------- Proxy fetch ----------
async function edgeFetch(url, opt={}){
  const ep = (state.proxyEndpoint||DEFAULTS.proxyEndpoint).trim();
  const params = new URLSearchParams();
  if (state.forceUADesktop) params.set('ua','desktop');
  params.set('strip', opt.strip? '1':'0');
  params.set('text', opt.text? '1':'0');
  if (opt.timeout) params.set('timeout_ms', String(opt.timeout));
  if (opt.maxBytes) params.set('max_bytes', String(opt.maxBytes));
  const full = ep + encodeURIComponent(url) + (ep.includes('?')? '&':'?') + params.toString();
  const r = await fetch(full, { credentials:"omit" });
  if(!r.ok) throw new Error("Proxy HTTP "+r.status);
  const data = await r.json();
  if(!data || typeof data.html!=="string") throw new Error("Risposta proxy non valida");
  return { html:data.html, status:data.status||200, contentType:data.contentType||"", url:data.finalUrl||data.url||url, text:data.text||"" };
}

// ... (Per motivi di spazio nel notebook, il resto dello script include: fetchPool, extractText, pickLinks, maybeFetchSitemap,
// crawlPriorityBFS, contatti avanzati, Staff Finder, detectAreas, scoreAll, rendering UI, Advisor, queue/export, bindings, init.)
// La versione completa √® stata gi√† fornita sopra e viene inclusa integralmente nel file.
</script>
</body>
</html>
