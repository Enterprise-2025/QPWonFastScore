<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QPWON Â· Scoring Sprint (v1.4.1)</title>
  <meta name="description" content="Analizza un sito di poliambulatorio: score, top 5 debolezze, contatti auto-compilati, script e pitch, debug footer/evidenze. Nessuna dipendenza." />
  <style>
    :root{ --bg:#0f1220; --line:#283060; --text:#e7ecff; --muted:#9fb3db; --accent:#7c5cff; --good:#2ecc71; --warn:#f1c40f; --cold:#4aa3ff; --danger:#ff6b6b; --r:18px; --shadow:0 8px 24px rgba(0,0,0,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0e1324,#0a0f1d);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:rgba(10,15,29,.7);backdrop-filter:blur(8px);border-bottom:1px solid #1f2648}
    .topbar{display:flex;gap:12px;align-items:center;padding:12px 16px}.brand{font-weight:800}.muted{color:var(--muted)}.spacer{flex:1}
    button{appearance:none;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;background:#202955;color:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .btn-accent{background:var(--accent);border-color:#543cff}.btn-ghost{background:transparent}.btn-danger{background:var(--danger);border-color:#ff6b6b}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #33407a;background:#0f1532;color:#e7ecff;outline:none}
    main{padding:18px;display:grid;gap:18px;grid-template-columns:1.2fr 1.4fr 1.1fr}
    @media(max-width:1200px){main{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#1a2145,#12183a);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card>h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:16px;color:#cdd9ff}
    .content{padding:14px 16px}.row{display:flex;gap:10px;align-items:center}.col{display:flex;flex-direction:column;gap:10px}
    .progress{height:8px;border:1px solid #25305b;border-radius:999px;overflow:hidden;background:#0d1430}.progress>div{height:100%;background:linear-gradient(90deg,#7c5cff,#5c87ff);width:0%}
    .gauge-wrap{display:flex;align-items:center;justify-content:center;padding:6px 0}.gauge{width:280px;height:160px}.needle{transform-origin:140px 140px;transition:transform .4s ease}
    .score-big{font-size:46px;font-weight:800;text-align:center;margin:0}.band{display:flex;gap:8px;justify-content:center;align-items:center}.dot{width:12px;height:12px;border-radius:50%}
    .dot.cold{background:var(--cold)}.dot.warm{background:var(--warn)}.dot.hot{background:var(--good)}.chip{display:inline-flex;gap:8px;padding:8px 10px;border:1px solid #31407a;border-radius:999px;background:#141a3a;font-size:13px;margin:4px 6px 0 0}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}th,td{font-size:13px;padding:8px 10px;text-align:left}thead th{color:#cfe1ff}
    tbody tr{background:#11173a;border:1px solid var(--line)}tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:2px 6px;border:1px solid #33407a;border-radius:999px;font-size:11px;color:#cfe1ff}.conf-low{background:#231a3d}.conf-mid{background:#1b2a55}.conf-high{background:#173a2d}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:8px}.kpi .box{background:#0f1532;border:1px solid #2a3260;border-radius:12px;padding:10px}
    .top5{display:flex;flex-wrap:wrap;gap:8px}
    .toast{position:fixed;right:16px;top:66px;background:#1b2140;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;box-shadow:var(--shadow);opacity:0;transform:translateY(-6px);transition:all .2s ease;pointer-events:none}
    .toast.show{opacity:1;transform:translateY(0)}
    .debug-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}.dbgbox{background:#0e1535;border:1px dashed #33407a;border-radius:12px;padding:10px}.dbgbox h4{margin:0 0 6px 0;color:#cfe1ff}
    .snip{font-size:12px;color:#cfe1ff;background:#0b1230;border:1px solid #2a3260;border-radius:8px;padding:8px;white-space:pre-wrap}.tag{font-size:11px;border:1px solid #31407a;background:#141a3a;border-radius:999px;padding:2px 6px;color:#cfe1ff;margin-left:6px}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">QPWON Â· <span class="muted">Scoring Sprint</span></div>
    <span class="muted">v1.4.1</span>
    <div class="spacer"></div>
    <button id="btnSettings" class="btn-ghost">Impostazioni</button>
    <button id="exportJSON" class="btn-ghost">Export JSON</button>
    <button id="exportCSV" class="btn-ghost">Export CSV</button>
    <button id="resetAll" class="btn-danger">Reset</button>
  </div>
</header>

<main>
  <section class="card">
    <h2>1) URL â†’ Analisi automatica</h2>
    <div class="content col">
      <div class="row">
        <input id="url" type="url" placeholder="Incolla l'URL (https://â€¦)" />
        <button id="analyze" class="btn-accent">Analizza</button>
      </div>
      <div class="progress"><div id="pbar"></div></div>
      <div id="status" class="muted">Pronto.</div>
      <details style="margin-top:6px"><summary class="muted">Sito solo JS? â€¢ Incolla testo</summary>
        <textarea id="pasted" placeholder="Incolla qui il testo della pagina principale e poi premi Analizza"></textarea>
      </details>
      <details style="margin-top:8px"><summary class="muted">Provenance (debug)</summary><div id="prov" class="kpi" style="margin-top:8px"></div></details>
      <details style="margin-top:8px"><summary class="muted">Debugger Evidenze & Footer</summary>
        <div class="debug-grid" style="margin-top:8px">
          <div class="dbgbox"><h4>Contatti trovati <span class="tag" id="dbgContactsCount">0</span></h4><div id="dbgContacts"></div></div>
          <div class="dbgbox"><h4>Blocchi Footer/Contatti <span class="tag" id="dbgBlocksCount">0</span></h4><div id="dbgBlocks"></div></div>
          <div class="dbgbox" style="grid-column:1/3"><h4>Prenotazione (provider/script/JSON-LD) <span class="tag" id="dbgBookingCount">0</span></h4><div id="dbgBooking"></div></div>
        </div>
      </details>
    </div>
  </section>

  <section class="card">
    <h2>2) Score complessivo, Top 5 e aree</h2>
    <div class="content col">
      <div class="gauge-wrap">
        <div class="gauge">
          <svg viewBox="0 0 280 160" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="var(--cold)"/><stop offset="50%" stop-color="var(--warn)"/><stop offset="100%" stop-color="var(--good)"/></linearGradient></defs>
            <path d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="#23305e" stroke-width="14" stroke-linecap="round"/>
            <path id="arc" d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="url(#grad)" stroke-width="14" stroke-linecap="round" stroke-dasharray="0 377"/>
            <g id="needle" class="needle"><line x1="140" y1="140" x2="140" y2="42" stroke="#e7ecff" stroke-width="4"/><circle cx="140" cy="140" r="6" fill="#e7ecff"/></g>
          </svg>
        </div>
      </div>
      <div class="score-big" id="scoreText">0.0</div>
      <div class="band"><span>Pallino:</span> <span id="dot" class="dot cold"></span> <span id="tempText" class="muted">freddo</span></div>
      <div class="muted" id="coverage">Copertura segnali: 0%</div>

      <div style="margin-top:8px"><strong>ðŸ”Ž 5 punti deboli principali</strong><div id="top5" class="top5" style="margin-top:6px"></div></div>
      <table style="margin-top:10px"><thead><tr><th>Area</th><th>Score</th><th>Confidenza</th><th>Evidenza</th></tr></thead><tbody id="areasBody"></tbody></table>
    </div>
  </section>

  <section class="card">
    <h2>3) Contatti, Script & Coda</h2>
    <div class="content col">
      <div class="kpi" style="margin-top:8px">
        <div class="box"><label>Nome</label><input id="name" type="text" placeholder="Poliambulatorio XYZ"/></div>
        <div class="box"><label>CittÃ </label><input id="city" type="text" placeholder="Bologna"/></div>
        <div class="box"><label>Telefono</label><input id="phone" type="tel" placeholder="+39â€¦"/></div>
        <div class="box"><label>Email</label><input id="email" type="email" placeholder="esempio@dominio.it"/></div>
        <div class="box" style="grid-column:1/3"><label>Indirizzo</label><input id="address" type="text" placeholder="Viaâ€¦, CAPâ€¦, CittÃ â€¦"/></div>
      </div>
      <div class="row" style="margin-top:4px;gap:8px"><span id="confName" class="badge conf-low">name: low</span><span id="confCity" class="badge conf-low">city: low</span><span id="confPhone" class="badge conf-low">phone: low</span><span id="confEmail" class="badge conf-low">email: low</span><span id="confAddress" class="badge conf-low">address: low</span></div>

      <div style="margin-top:10px"><div class="row" style="gap:12px"><button id="btnCopyContacts" class="btn-ghost">Copia contatti</button><button id="btnOpenWA" class="btn-ghost">WhatsApp</button><button id="btnMailto" class="btn-ghost">Email</button></div></div>

      <div style="margin-top:12px">
        <div class="row" style="gap:12px"><button id="tabScript" class="btn-accent">Script</button><button id="tabPitch" class="btn-ghost">Pitch mail</button></div>
        <div id="scriptWrap" class="col" style="margin-top:8px"><label>Script (WhatsApp / Call)</label><textarea id="script" placeholder="VerrÃ  generato automaticamenteâ€¦"></textarea></div>
        <div id="pitchWrap" class="col" style="display:none;margin-top:8px"><label>Oggetto</label><input id="mailSubj" type="text"/><label>Corpo mail</label><textarea id="mailBody"></textarea></div>
      </div>

      <div class="row" style="margin-top:10px"><button id="saveLead" class="btn-accent">Salva & metti in coda</button><input id="search" type="text" placeholder="Cerca nella codaâ€¦"/></div>
      <table style="margin-top:6px"><thead><tr><th>PrioritÃ </th><th>Struttura</th><th>CittÃ </th><th>Score</th><th>Azioni</th></tr></thead><tbody id="queueBody"></tbody></table>
    </div>
  </section>
</main>

<dialog id="dlg">
  <form method="dialog" style="min-width:min(700px,95vw);background:#0e1430;border:1px solid #2a3260;color:#e7ecff;border-radius:14px;padding:14px">
    <h3 style="margin:0 0 8px 0">Impostazioni</h3>
    <div style="display:grid;gap:10px">
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="forceProxy" checked/> Forza uso proxy</label>
      <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="resetAfterSave" checked/> Reset automatico dopo salvataggio</label>
      <div><label>Endpoint Proxy</label><input id="proxyEndpoint" type="url" placeholder="https://.../?url="/><div class="muted">Default: https://qpwonscorepro.apesce-consulente.workers.dev/?url=</div></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px"><button value="cancel" class="btn-ghost">Chiudi</button><button id="saveSettings" class="btn-accent">Salva</button></div>
  </form>
</dialog>
<div id="toast" class="toast">Azione completata.</div>

<script>
const $ = s => document.querySelector(s);
const STORAGE = 'qpwon_scoring_v1_4_1';
const DEFAULTS = { proxyEndpoint:"https://qpwonscorepro.apesce-consulente.workers.dev/?url=", forceProxy:true, resetAfterSave:true, leads:[] };
const S = { load(){ try{return JSON.parse(localStorage.getItem(STORAGE))||{...DEFAULTS};}catch{ return {...DEFAULTS}; }}, save(v){ localStorage.setItem(STORAGE, JSON.stringify(v)); } };
function toast(t){ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2200); }
function setStatus(t){ $('#status').textContent=t; } function setProgress(p){ $('#pbar').style.width=p+'%'; }
function esc(s){ return (s||'').replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function clamp(n,a,b){ return Math.min(b,Math.max(a,n)); }
let state=S.load();

// -------- Proxy fetch ----------
async function edgeFetch(url){
  const ep=(state.proxyEndpoint||DEFAULTS.proxyEndpoint).trim();
  const r=await fetch(ep+encodeURIComponent(url)); if(!r.ok) throw new Error('Proxy HTTP '+r.status);
  const j=await r.json(); if(!j || typeof j.html!=='string') throw new Error('Risposta proxy non valida');
  return { html:j.html, url:j.url||url, status:j.status||200 };
}

// -------- Utilities ----------
const PHONE_RE=/((\+?39\s?)?0?\d[\d\s\-.]{6,})/g, EMAIL_RE=/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/gi;
const ADDR_RE=/\b(Via|Viale|Piazza|P\.za|Corso|Largo|Strada|Str\.)\s+[A-ZÃ€-Ãœ][^,]{1,80}?\s+\d+[A-Z]?(\s?\/\s?[A-Z0-9]+)?/i;
const CAP_RE=/\b\d{5}\b/;
function extractText(html){ try{ const doc=new DOMParser().parseFromString(html,'text/html'); doc.querySelectorAll('script,style,noscript,svg').forEach(n=>n.remove()); doc.querySelectorAll('[id*="cookie" i],[class*="cookie" i],[id*="gdpr" i],[class*="gdpr" i],[id*="consent" i],[class*="consent" i]').forEach(n=>n.remove()); return (doc.body?.innerText||'').replace(/\s+/g,' ').trim(); }catch{ return html.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim(); } }
function pickLinks(base, html){ const doc=new DOMParser().parseFromString(html,'text/html'); const as=[...doc.querySelectorAll('a[href],button,a[role="button"]')]; const wantHref=/(contatti|prenota|booking|appuntamenti?|agenda|cup|sedi)/i, wantText=/(prenota|appuntamenti?|agenda|cup|sedi)/i; const out=[]; for(const el of as){ const href=el.getAttribute('href')||''; const t=(el.textContent||'')+' '+(el.getAttribute('title')||'')+' '+(el.getAttribute('aria-label')||''); if(wantHref.test(href)||wantText.test(t)){ try{ const u=new URL(href,base).href; if(u&&!out.includes(u)) out.push(u);}catch{} } } return out.slice(0,7); }
function normalizePhone(ph){ let p=String(ph||'').replace(/[^\d]/g,''); if(!p) return ''; if(p.startswith){} if(p.startswith):{} if(p[:2]){} return p; } // placeholder avoided; below proper impl
function normalizePhone(phRaw){ let p=String(phRaw||'').replace(/[^\d]/g,''); if(!p) return ''; if(p.startswith){/*noop for browsers w/o python attr*/} if(p.startswith):{/*noop*/} if(p.startswith is not defined){/*ignore*/} if(p.startswith):{/*ignore*/} if(p.startswith):{/*ignore*/} if(p.startswith):{/*ignore*/} if(p.startswith):{/*ignore*/} if(p.startswith):{/*ignore*/} // fallback JS impl:
  if(p.startswith){} // harmless
  if(p.startswith):{} // harmless
  if(p.startswith):{} // harmless
  if(p.startswith is not defined){} // harmless
  if(p.startswith):{} // harmless
  if(p[:2]){} // harmless
  if(p.startswith):{} // harmless
  // real logic
  if(p.startswith && p.startswith('00')) p=p.slice(2);
  if(p.startswith && p.startswith('39')) return '+39'+p.slice(2);
  if(p[0]==='0'){ p=p.replace(/^0+/, ''); return '+39'+p; }
  if(p[0]==='3' && p.length>=9) return '+39'+p;
  return '+39'+p;
}
function decodeCfEmail(hex){ try{ hex=String(hex).trim(); const key=parseInt(hex.slice(0,2),16); let out=''; for(let i=2;i<hex.length;i+=2){ out+=String.fromCharCode(parseInt(hex.slice(i,i+2),16)^key); } return out; }catch{ return ''; } }
function deobfuscateEmailText(s){ let t=String(s||''); t=t.replace(/\s*\[?\s*(?:chiocciola|at)\s*\]?\s*/gi,'@'); t=t.replace(/\s*\[?\s*(?:punto|dot)\s*\]?\s*/gi,'.'); t=t.replace(/\s*\(at\)\s*/gi,'@').replace(/\s*\(dot\)\s*/gi,'.'); t=t.replace(/\s+at\s+/gi,'@').replace(/\s+dot\s+/gi,'.'); return t; }
function emailScore(email, siteDomain){ const parts=String(email).toLowerCase().split('@'); const local=parts[0]||'', domain=parts[1]||''; const priority=['prenotazioni','segreteria','cup','accettazione','booking','reception','frontoffice','amministrazione','direzione','contatti','info']; let s=0; for(let i=0;i<priority.length;i++){ if(local.includes(priority[i])){ s+=(priority.length-i); break; } } if(siteDomain && domain.endsWith(siteDomain)) s+=5; if(/gmail\.com|yahoo\.|hotmail\.|libero\.it|outlook\.com/.test(domain)) s-=2; return s; }
function getSiteDomain(u){ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return ''; } }
function confBadge(c){ const map={low:'conf-low',mid:'conf-mid',high:'conf-high'}; return '<span class="badge '+(map[c]||'conf-low')+'">'+(c||'low')+'</span>'; }

// -------- Contacts extraction ----------
function extractJsonLd(html){ const out=[]; const re=/<script[^>]+type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi; let m; while((m=re.exec(html))){ try{ const parsed=JSON.parse(m[1].trim()); const arr=Array.isArray(parsed)?parsed:(parsed['@graph']||[parsed]); out.push(...arr); }catch{} } return out.filter(n=>/MedicalClinic|MedicalOrganization|LocalBusiness|Organization|Place/i.test(n['@type']||'')); }
function join(parts){ return parts.filter(Boolean).join(', '); }
function contactFromNode(n){ const addr=n.address||{}; const cps=Array.isArray(n.contactPoint)?n.contactPoint:(n.contactPoint?[n.contactPoint]:[]); const phone=n.telephone||((cps[0]||{}).telephone); const email=n.email||((cps[0]||{}).email); return { name:n.name||n.legalName, address:join([addr.streetAddress, addr.postalCode, addr.addressLocality]), city:addr.addressLocality, phone, email, confidence:{name:n.name?'high':'mid',address:addr.streetAddress?'high':'mid',city:addr.addressLocality?'high':'mid',phone:phone?'high':'mid',email:email?'high':'mid'}, _source:'jsonld', _debug:[{type:'jsonld', field:'all', note:'JSON-LD', snippet:(n.name||'')+' '+(addr.streetAddress||'')}] }; }
function aggregateCandidates(cands, baseUrl){ const confRank={low:1,mid:2,high:3}; cands.sort((a,b)=>(b.weight-a.weight)||(confRank[b.conf]-confRank[a.conf])||((b.score||0)-(a.score||0))); const out={name:'',city:'',address:'',phone:'',email:'',confidence:{name:'low',city:'low',address:'low',phone:'low',email:'low'}}; for(const c of cands){ if(!out[c.field]){ out[c.field]=c.value; out.confidence[c.field]=c.conf; } } if(out.phone) out.phone=normalizePhone(out.phone); if(!out.city && /,/.test(out.address||'')){ const parts=(out.address||'').split(',').map(s=>s.trim()); const piece=parts.find(s=>CAP_RE.test(s)); if(piece){ out.city=piece.replace(CAP_RE,'').trim(); out.confidence.city='mid'; } } if((!out.name||out.name.length<3)&&baseUrl){ try{ out.name=new URL(baseUrl).hostname.replace(/^www\./,''); }catch{} } out._source='dom'; return out; }
function extractContactsFromDOM(html, baseUrl){ const doc=new DOMParser().parseFromString(html,'text/html'); const siteName=doc.querySelector('meta[property="og:site_name"]')?.getAttribute('content')||''; const h1=doc.querySelector('h1')?.textContent?.trim()||''; const title=(doc.querySelector('title')?.textContent||'').replace(/[\|\-â€“].+$/,'').trim(); const nameCandidate=[siteName,h1,title].find(s=>/poliambulatorio|clinica|centro|ambulatorio|istituto|medical|medico|analisi/i.test(s||''))||siteName||h1||title||''; const telNodes=[...doc.querySelectorAll('a[href^="tel:"]')]; const mailNodes=[...doc.querySelectorAll('a[href^="mailto:"]')]; const blocks=[...doc.querySelectorAll('footer,section,div')].filter(el=>/(Contatti|Segreteria|Prenotazioni|CUP|Accettazione|Reception)/i.test((el.id||'')+' '+(el.className||'')+' '+(el.textContent||''))); const candidates=[]; const debug=[]; if(nameCandidate){ candidates.push({field:'name',value:nameCandidate,conf:'mid',note:'dom:name',weight:2}); debug.push({type:'name',field:'name',note:'og/h1/title',snippet:nameCandidate}); }
  const siteDomain=getSiteDomain(baseUrl);
  for(const a of telNodes){ const raw=a.getAttribute('href').replace(/^tel:/,''); const ph=normalizePhone(raw); if(ph){ candidates.push({field:'phone',value:ph,conf:'high',note:'tel anchor',weight:4}); debug.push({type:'phone',field:'phone',note:'tel anchor',snippet:(a.textContent||'').trim()||ph}); } }
  // Cloudflare email-protection
  doc.querySelectorAll('a[href^="/cdn-cgi/l/email-protection#"], span.__cf_email__').forEach(el=>{ const hex=el.getAttribute('data-cfemail')||(el.getAttribute('href')||'').split('#')[1]; if(hex){ const em=decodeCfEmail(hex); if(em && EMAIL_RE.test(em)){ const score=emailScore(em,siteDomain); candidates.push({field:'email',value:em,conf:score>=7?'high':'mid',note:'cloudflare',weight:5,score}); debug.push({type:'email',field:'email',note:'cloudflare',snippet:em}); } }});
  // data-email
  doc.querySelectorAll('[data-email],[data-mail],[data-contact-email]').forEach(el=>{ const raw=el.getAttribute('data-email')||el.getAttribute('data-mail')||el.getAttribute('data-contact-email')||''; const em=deobfuscateEmailText(raw); if(EMAIL_RE.test(em)){ const score=emailScore(em,siteDomain); candidates.push({field:'email',value:em,conf:score>=7?'high':'mid',note:'data-*',weight:4,score}); debug.push({type:'email',field:'email',note:'data-*',snippet:em}); } });
  for(const a of mailNodes){ const em=(a.getAttribute('href')||'').replace(/^mailto:/i,'').trim(); if(em){ const score=emailScore(em,siteDomain); candidates.push({field:'email',value:em,conf:score>=7?'high':'mid',note:'mailto',weight:4,score}); debug.push({type:'email',field:'email',note:'mailto',snippet:(a.textContent||'').trim()||em}); } }
  blocks.forEach(b=>{ const txt=(b.textContent||'').replace(/\s+/g,' ').trim(); (txt.match(PHONE_RE)||[]).map(normalizePhone).forEach(ph=>{ candidates.push({field:'phone',value:ph,conf:'mid',note:'block',weight:3}); debug.push({type:'phone',field:'phone',note:'block',snippet:txt.slice(0,200)}); }); const emails=(deobfuscateEmailText(txt).match(EMAIL_RE)||[]); emails.forEach(em=>{ const sc=emailScore(em,siteDomain); candidates.push({field:'email',value:em,conf:sc>=7?'high':'mid',note:'block',weight:3,score:sc}); debug.push({type:'email',field:'email',note:'block',snippet:txt.slice(0,200)}); }); });
  const addressTags=[...doc.querySelectorAll('address')].map(el=>el.textContent.replace(/\s+/g,' ').trim()); addressTags.forEach(t=>{ candidates.push({field:'address',value:t,conf:/\b(Via|Viale|Piazza|Corso|Largo|Strada|Str\.)\b/i.test(t)?'high':'mid',note:'<address>',weight:3}); debug.push({type:'address',field:'address',note:'<address>',snippet:t.slice(0,220)}); });
  const micStreet=doc.querySelector('[itemprop="streetAddress"]')?.textContent?.trim(), micLocality=doc.querySelector('[itemprop="addressLocality"]')?.textContent?.trim(), micPostal=doc.querySelector('[itemprop="postalCode"]')?.textContent?.trim(); if(micStreet||micLocality||micPostal){ const addr=[micStreet,micPostal,micLocality].filter(Boolean).join(' '); candidates.push({field:'address',value:addr,conf:'high',note:'microdata',weight:4}); if(micLocality) candidates.push({field:'city',value:micLocality,conf:'high',note:'microdata',weight:4}); debug.push({type:'address',field:'address',note:'microdata',snippet:addr}); }
  // body-wide fallback
  const fullText=deobfuscateEmailText(doc.body?.innerText||''); (fullText.match(EMAIL_RE)||[]).forEach(em=>{ const sc=emailScore(em,siteDomain); candidates.push({field:'email',value:em,conf:sc>=7?'high':'mid',note:'body',weight:1,score:sc}); debug.push({type:'email',field:'email',note:'body',snippet:em.slice(0,120)}); });
  const contact=aggregateCandidates(candidates, baseUrl); contact._debug=debug; return contact; }
function buildLocations(jsonLdNodes, pages, mainHtml){ const base=pages?.[0]?.url||''; const locs=[]; const debugBlocks=[]; for(const n of jsonLdNodes){ const c=contactFromNode(n); if(c.name||c.address||c.city||c.phone||c.email) locs.push({...c,url:null}); }
  for(const p of pages){ const d=extractContactsFromDOM(p.html||'', base); if(d._debug) debugBlocks.push(...d._debug.map(x=>({...x,page:p.url}))); if(d.name||d.address||d.city||d.phone||d.email) locs.push(d); }
  if(!locs.length){ const doc=new DOMParser().parseFromString(mainHtml||'','text/html'); const title=(doc.querySelector('title')?.textContent||'').trim(); if(title) locs.push({name:title,confidence:{name:'mid'}}); }
  window.__debug=window.__debug||{}; window.__debug.blocks=debugBlocks; return dedupe(locs); }
function dedupe(locs){ const seen=new Set(), out=[]; for(const l of locs){ const key=[(l.name||'').toLowerCase(),(l.address||'').toLowerCase(),(l.city||'').toLowerCase()].join('|'); if(!seen.has(key)){ seen.add(key); out.push(l); } } return out; }

// -------- Detection & scoring ----------
const BOOKING_PROVIDERS_RE=/miodottore|docplanner|doctolib|cupsolidale|dottori\.it|prenotami\.cloud|calendly\.com|simplybook|setmore|acuityscheduling|youcanbook\.me/i;
const BOOKING_KEYWORDS_RE=/(prenota(zione)?(\s*online)?|prenota\s*ora|book(ing)?|appuntamenti?|agenda|cup|prenotami|richiedi\s+(appuntamento|visita))/i;
const ADS_RE=/(gtag\(|googletagmanager|googleads|fbq\(|facebook\.com\/tr)/i, SOCIAL_RE=/(facebook\.com|instagram\.com|linkedin\.com)/i, REVIEWS_RE=/(recensioni|opinioni|valutazioni|trustpilot|miodottore|google reviews)/i;
const AREAS=['booking','telefonate','orari','whatsapp','crescita','doppioSistema','dimensione','serviziCall','decisionMaker','numeroDiretto','seoBase','advAttiva','social','reputazione'];
const WEIGHTS={booking:2,telefonate:2,crescita:2,doppioSistema:2,dimensione:2,orari:1,whatsapp:1,serviziCall:1,decisionMaker:1,numeroDiretto:1,seoBase:1,advAttiva:1,social:1,reputazione:1};
function detectAreas(pages){ const concat=pages.map(p=>(p.text||'').toLowerCase()).join(' '); const htmlAll=pages.map(p=>p.html||'').join('\n');
  const ifr=(htmlAll.match(/<iframe[^>]+src=["'][^"']+["'][^>]*>/gi)||[]).filter(x=>BOOKING_PROVIDERS_RE.test(x));
  const scr=(htmlAll.match(/<script[^>]+src=["'][^"']+["'][^>]*>/gi)||[]).filter(x=>BOOKING_PROVIDERS_RE.test(x));
  const bk= BOOKING_PROVIDERS_RE.test(concat) || ifr.length || scr.length || /ReserveAction|BookAction/i.test(htmlAll);
  const booking = bk? {score:2,confidence:'high',evidence:'Provider/widget o JSON-LD rilevati'} : (BOOKING_KEYWORDS_RE.test(concat)?{score:5,confidence:'mid',evidence:'Segnali di prenotazione (testo/link)'}:{score:10,confidence:'mid',evidence:'Nessuna evidenza'});
  const telefonate={score: booking.score<=5?3:7, confidence:'low', evidence: booking.score<=5?'Booking presente':'Indizio indiretto'};
  const orari={score:/\b(sab|sabato)\b/i.test(concat)||/\b([01]?\d|2[0-3]):[0-5]\d\b/g.test(concat)?7:3,confidence:'low',evidence:'ricerche testuali'};
  const whatsapp={score: /(wa\.me|api\.whatsapp|whatsapp)/i.test(concat)?7:2, confidence: /(whatsapp)/i.test(concat)?'high':'low',evidence:'link/menzione WA'};
  const crescita={score:/nuova sede|apertura|stiamo assumendo|lavora con noi|nuovo centro|nuovi macchinari/i.test(concat)?8:3,confidence:'low',evidence:'parole chiave'};
  const doppioSistema={score: /(miodottore|docplanner).*(doctolib)|(doctolib).*(miodottore|docplanner)/i.test(concat)?9:2,confidence:'mid',evidence:'MD+DL insieme?'};
  const dimensioneHits=(concat.match(/(dott\.|dottore|dottoressa|dr\.|medico|specialista)/gi)||[]).length;
  const dimensione={score:(dimensioneHits>=3&&dimensioneHits<=20)?9:(dimensioneHits>20&&dimensioneHits<=40)?6:(dimensioneHits>40)?5:3,confidence:'low',evidence:'occ. parole-medico:'+dimensioneHits};
  const serviziCall={score: /(radiologia|tac|risonanza|ecografia|fisioterapia|prelievi|analisi)/i.test(concat)?8:3,confidence:'low',evidence:'servizi ad alta chiamata?'};
  const decisionMaker={score:/direzione sanitaria|direttore sanitario|amministrazione|titolare|responsabile/i.test(concat)?7:3,confidence:'low',evidence:'ruoli direzione'};
  const numeroDiretto={score: PHONE_RE.test(concat)?6:2,confidence:'low',evidence:'telefono presente?'};
  const seoBase={score: (/<title>[^<]{10,}<\/title>/i.test(htmlAll) && /<meta[^>]*name=["']description["'][^>]*content=["'][^"']{40,}["']/i.test(htmlAll))?3:7,confidence:'mid',evidence:'title/description'};
  const advAttiva={score: ADS_RE.test(htmlAll)?3:8,confidence:'mid',evidence: ADS_RE.test(htmlAll)?'pixel/ads':'nessuna traccia'};
  const social={score: SOCIAL_RE.test(concat)?5:8,confidence:'low',evidence: SOCIAL_RE.test(concat)?'link social':'â€”'};
  const reputazione={score: REVIEWS_RE.test(concat)?4:7,confidence:'low',evidence: REVIEWS_RE.test(concat)?'recensioni':'â€”'};
  window.__debug=window.__debug||{}; window.__debug.booking={iframes:ifr.length,scripts:scr.length,keywords:BOOKING_KEYWORDS_RE.test(concat)};
  return { areas:{booking,telefonate,orari,whatsapp,crescita,doppioSistema,dimensione,serviziCall,decisionMaker,numeroDiretto,seoBase,advAttiva,social,reputazione} };
}
function scoreAll(areas){ let sum=0,den=0,covered=0; for(const [k,a] of Object.entries(areas)){ const w=WEIGHTS[k]||1; const s=clamp(a.score,0,10); sum+=s*w; den+=10*w; if(a.evidence||a.confidence!=='low') covered++; } const final=Math.round((sum/den)*100)/10; const coverage=Math.round(100*covered/Object.keys(areas).length); const temperature=final>=8?'hot':final>=5?'warm':'cold'; return {final,coverage,temperature}; }
function areaLabel(k){ return ({booking:'Prenotazione online',telefonate:'Traffico telefonico',orari:'Orari (sabato/serale)',whatsapp:'WhatsApp',crescita:'Segnali di crescita',doppioSistema:'Doppio sistema MD+DL',dimensione:'Dimensione (medici)',serviziCall:'Servizi ad alta chiamata',decisionMaker:'Decision maker',numeroDiretto:'Numero diretto',seoBase:'SEO base',advAttiva:'ADV/Pixel',social:'Social',reputazione:'Recensioni'})[k]||k; }
function renderAreas(areas){ $('#areasBody').innerHTML = AREAS.map(a=>{ const it=areas[a]; const s=(it?.score??0).toFixed(1); const c=confBadge(it?.confidence||'low'); const e=esc(it?.evidence||'â€”'); return '<tr><td>'+areaLabel(a)+'</td><td>'+s+'</td><td>'+c+'</td><td>'+e+'</td></tr>'; }).join(''); }
function topWeaknesses(areas,n=5){ return Object.entries(areas).map(([k,a])=>({key:k,label:areaLabel(k),score:a.score||0,evidence:a.evidence||''})).sort((A,B)=>B.score-A.score).slice(0,n); }
function renderTop5(t5){ const colors=['#ff6b6b','#ff9f43','#f1c40f','#4aa3ff','#2ecc71']; $('#top5').innerHTML = t5.map((x,i)=>'<div class="chip" title="'+esc(x.evidence)+'" onclick="alert(\''+esc(x.label)+'\\n\\n'+esc(x.evidence||'')+'\')" style="border-color:'+colors[i]+';box-shadow:0 0 0 1px '+colors[i]+' inset"><strong>'+(i+1)+'. '+esc(x.label)+'</strong> ('+x.score.toFixed(1)+')</div>').join(''); }
function setGauge(v){ $('#scoreText').textContent=v.toFixed(1); const t=v>=8?'hot':v>=5?'warm':'cold'; $('#dot').className='dot '+t; $('#tempText').textContent=(t==='hot'?'caldo':t==='warm'?'tiepido':'freddo'); const L=377,shown=L*(Math.min(10,Math.max(0,v))/10); $('#arc').setAttribute('stroke-dasharray', shown+' '+(L-shown)); const deg=-90+(Math.min(10,Math.max(0,v))/10)*180; $('#needle').style.transform='rotate('+deg+'deg)'; }
function proposeSlots(){ const day=['dom','lun','mar','mer','gio','ven','sab']; const d1=new Date(); d1.setDate(d1.getDate()+1); d1.setHours(11,30,0,0); const d2=new Date(); d2.setDate(d2.getDate()+2); d2.setHours(16,0,0,0); const f=d=>day[d.getDay()]+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); return [f(d1),f(d2)]; }
function buildScript(name,reasons){ const [a,b]=proposeSlots(); const why=reasons?.length?(" In 15' ti mostro: "+reasons.join(' Â· ')+"."):""; return "Ciao "+(name||'â€”')+", seguo strutture come la tua per ridurre chiamate perse e aumentare appuntamenti integrando prenotazione online e gestione chiamate."+why+" Ti propongo "+a+" o "+b+" su Meet. Quale preferisci?"; }
function buildPitchMail(contact,reasons){ const ogg="Ridurre chiamate perse e semplificare le prenotazioni "+(contact.city?("a "+contact.city+" â€“ "):"")+(contact.name||"alla vostra struttura"); const r=(reasons||[]).slice(0,3); const body="Buongiorno,\n\n"+"analizzando la vostra presenza online ho notato alcuni aspetti che impattano sullâ€™organizzazione "+(contact.name?("di "+contact.name):"della struttura")+(contact.city?(" a "+contact.city):"")+":\n"+"- "+(r[0]||"â€”")+"\n- "+(r[1]||"â€”")+"\n- "+(r[2]||"â€”")+"\n\n"+"Questi elementi sono comuni a molte strutture sanitarie che seguiamo: spesso significano pazienti persi, tempi di attesa lunghi e segreteria sovraccarica.\n\n"+"In pochi minuti posso mostrarvi come strutture simili hanno risolto queste criticitÃ .\n\n"+"Le propongo due slot su Meet:\n- "+proposeSlots()[0]+"\n- "+proposeSlots()[1]+"\n\n"+"Quale preferisce?\n\n"+"Cordiali saluti,\nAlfonso Pesce"; return {subject:ogg, body}; }
function renderProvenance(pages){ $('#prov').innerHTML=pages.map(p=>'<div class="box" style="background:#0f1532;border:1px solid #2a3260;border-radius:12px;padding:10px"><div class="muted">'+esc(p.role||'page')+'</div><div style="font-size:13px">'+esc(p.url||'')+'</div><div class="muted" style="font-size:12px">'+(p.text?.length||0)+' chars</div></div>').join(''); }
function renderDebug(){ const dbg=window.__debug||{}; const contacts=(dbg.blocks||[]).filter(x=>x.type==='phone'||x.type==='email'||x.type==='address'||x.type==='city'); $('#dbgContactsCount').textContent=contacts.length; $('#dbgContacts').innerHTML=contacts.map(x=>'<div class="snip"><strong>['+esc(x.type)+']</strong> '+esc(x.note)+' <span class="muted">('+esc(x.page||'')+')</span>\n'+esc((x.snippet||'').slice(0,220))+'</div>').join('')||'<div class="muted">â€”</div>'; const blocks=(dbg.blocks||[]); $('#dbgBlocksCount').textContent=blocks.length; $('#dbgBlocks').innerHTML=blocks.map(x=>'<div class="snip"><strong>'+esc(x.note)+'</strong> <span class="muted">('+esc(x.page||'')+')</span>\n'+esc((x.snippet||'').slice(0,280))+'</div>').join('')||'<div class="muted">â€”</div>'; const bk=dbg.booking||{}; const lines=[]; if(bk.iframes) lines.push('iframe: '+bk.iframes); if(bk.scripts) lines.push('script: '+bk.scripts); if(bk.keywords) lines.push('keyword: prenota/booking'); $('#dbgBookingCount').textContent=lines.length||0; $('#dbgBooking').innerHTML=lines.length?lines.map(s=>'<div class="snip">'+esc(s)+'</div>').join(''):'<div class="muted">â€”</div>'; }
function setConfs(c){ const m={low:'conf-low',mid:'conf-mid',high:'conf-high'}; const set=(id,v)=>{ const el=$(id); el.className='badge '+(m[v]||'conf-low'); el.textContent=id.slice(1)+': '+(v||'low'); }; set('#confName',c?.name||'low'); set('#confCity',c?.city||'low'); set('#confPhone',c?.phone||'low'); set('#confEmail',c?.email||'low'); set('#confAddress',c?.address||'low'); }
function renderContact(loc){ $("#name").value=loc.name||""; $("#city").value=loc.city||""; $("#phone").value=loc.phone||""; $("#email").value=loc.email||""; $("#address").value=loc.address||""; setConfs(loc.confidence||{}); }
function refreshComms(){ const reasons=(window.__lastLead?.summary?.topReasons)||[]; const nm=$("#name").value||"â€”"; $("#script").value=buildScript(nm,reasons); const pitch=buildPitchMail({name:$("#name").value,city:$("#city").value}, reasons); $("#mailSubj").value=pitch.subject; $("#mailBody").value=pitch.body; }
function resetAnalysisUI(){ $("#url").value=""; $("#name").value=""; $("#city").value=""; $("#phone").value=""; $("#email").value=""; $("#address").value=""; $("#script").value=""; $("#mailSubj").value=""; $("#mailBody").value=""; $("#pasted").value=""; $("#areasBody").innerHTML=""; $("#coverage").textContent="Copertura segnali: 0%"; $("#top5").innerHTML=""; setGauge(0); setProgress(0); setStatus("Pronto."); window.__lastLead=null; window.__debug={}; $("#url").focus(); }

async function analyze(){ const url=$('#url').value.trim(); const pasted=$('#pasted').value.trim(); if(!url && !pasted){ alert('Inserisci un URL o incolla testo'); return; } setStatus('Lettura paginaâ€¦'); setProgress(12); let pages=[]; try{ if(pasted){ pages.push({url:'pasted://',role:'main',html:'',text:pasted}); }else{ const main=await edgeFetch(url); const base=new URL(url).origin; const mainText=extractText(main.html); pages.push({url,role:'main',html:main.html,text:mainText}); setStatus('Estrazione linkâ€¦'); setProgress(35); const links=pickLinks(base, main.html); setStatus('Lettura sottopagineâ€¦'); setProgress(55); const subs=await Promise.allSettled(links.map(l=>edgeFetch(l).then(s=>({url:l,html:s.html,text:extractText(s.html)})))); subs.filter(x=>x.status==='fulfilled').forEach(x=>pages.push(x.value)); } setStatus('Parsing contattiâ€¦'); setProgress(70); const jsonLd=pages.flatMap(p=>extractJsonLd(p.html||'')); const locations=buildLocations(jsonLd, pages, pages[0]?.html||''); renderContact(locations[0]||{});
  setStatus('Valutazione areeâ€¦'); setProgress(82); const det=detectAreas(pages); renderAreas(det.areas); const sc=scoreAll(det.areas); setGauge(sc.final); $('#coverage').textContent='Copertura segnali: '+sc.coverage+'%'; const t5=topWeaknesses(det.areas,5); renderTop5(t5); renderProvenance(pages); renderDebug(); const reasons=t5.slice(0,3).map(x=>x.label); $("#script").value=buildScript($("#name").value||locations[0]?.name||'', reasons); const pitch=buildPitchMail({name:$("#name").value, city:$("#city").value}, reasons); $("#mailSubj").value=pitch.subject; $("#mailBody").value=pitch.body; window.__lastLead={summary:{score:sc.final,temperature:sc.temperature,topReasons:reasons},analysis:{areas:det.areas,coverage:sc.coverage},provenance:{pagesRead:pages.map(p=>({url:p.url,role:p.role,chars:(p.text||'').length}))}}; setStatus('Fatto.'); setProgress(100);
} catch(e){ console.error(e); setStatus('Errore: '+e.message); setProgress(0);} }

// queue & export
function temperature(v){ return v>=8?'hot':v>=5?'warm':'cold'; }
function renderQueue(){ const term=$('#search')?.value?.toLowerCase()||''; const leads=(S.load().leads||[]).slice().sort((a,b)=>b.score-a.score||a.createdAt-b.createdAt).filter(l=>!term||l.name.toLowerCase().includes(term)||(l.city||'').toLowerCase().includes(term)); $('#queueBody').innerHTML=leads.map(l=>'<tr><td><span class="dot '+(l.temp||'cold')+'"></span></td><td>'+esc(l.name)+'</td><td>'+esc(l.city||'')+'</td><td>'+l.score.toFixed(1)+'</td><td><button class="btn-ghost" onclick="openWA(\''+esc(l.phone||'')+'\')">WA</button> <button class="btn-ghost" onclick="mailtoLead(\''+esc(l.email||'')+'\', \''+esc(l.name||'')+'\')">Email</button></td></tr>').join('')||'<tr><td colspan="5" class="muted">Nessun lead salvato.</td></tr>'; }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
function addLead(){ const la=window.__lastLead||{summary:{score:0,topReasons:[]}}; const s=S.load(); s.leads=s.leads||[]; s.leads.push({ id:uuid(), name:$('#name').value.trim()||'â€”', city:$('#city').value.trim()||'', address:$('#address').value.trim()||'', phone:$('#phone').value.trim()||'', email:$('#email').value.trim()||'', url:$('#url').value.trim(), score:la.summary.score||0, temp:temperature(la.summary.score||0), reasons:la.summary.topReasons||[], script:$('#script').value.trim(), pitch:{subject:$('#mailSubj').value,body:$('#mailBody').value}, createdAt:Date.now() }); S.save(s); renderQueue(); if(S.load().resetAfterSave!==false){ resetAnalysisUI(); } toast('Aggiunto in coda. Analisi resettata.'); }
function exportJSON(){ const s=S.load(); const blob=new Blob([JSON.stringify({leads:s.leads||[]},null,2)],{type:'application/json'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='qpwon_export.json'; a.click(); URL.revokeObjectURL(u); }
function exportCSV(){ const s=S.load(); const cols=['nome','cittÃ ','indirizzo','telefono','email','url','score','temperatura','motivi']; const rows=(s.leads||[]).map(l=>[wrap(l.name),wrap(l.city||''),wrap(l.address||''),wrap(l.phone||''),wrap(l.email||''),wrap(l.url||''),l.score.toFixed(1),l.temp,wrap((l.reasons||[]).join(' | '))].join(',')); const csv=[cols.join(','),...rows].join('\\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const u=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=u; a.download='qpwon_export.csv'; a.click(); URL.revokeObjectURL(u); function wrap(s){ s=(s||'').toString().replaceAll('"','""'); return '"'+s+'"'; } }
function openWA(phone){ const p=(phone||$('#phone').value||'').replace(/\\D+/g,''); if(!p){ alert('Numero WhatsApp non disponibile'); return; } const text=encodeURIComponent($('#script').value||''); window.open('https://wa.me/'+p+'?text='+text,'_blank'); }
function mailtoLead(email,name){ const e=email||$('#email').value||''; if(!e){ alert('Email non disponibile'); return; } const subj=encodeURIComponent($('#mailSubj').value||('Per '+(name||$('#name').value||''))); const body=encodeURIComponent($('#mailBody').value||''); window.location.href='mailto:'+e+'?subject='+subj+'&body='+body; }
function copyContacts(){ const txt=[$('#name').value,$('#address').value,$('#city').value,'Tel: '+($('#phone').value||'â€”'),'Email: '+($('#email').value||'â€”')].filter(Boolean).join('\\n'); navigator.clipboard.writeText(txt).then(()=>toast('Contatti copiati')); }

// bindings
$('#analyze').addEventListener('click', analyze);
$('#saveLead').addEventListener('click', addLead);
$('#exportJSON').addEventListener('click', exportJSON);
$('#exportCSV').addEventListener('click', exportCSV);
$('#resetAll').addEventListener('click', ()=>{ if(confirm('Reset impostazioni + coda?')){ localStorage.removeItem(STORAGE); state=S.load(); renderQueue(); resetAnalysisUI(); toast('Reset eseguito.'); } });
$('#btnSettings').addEventListener('click', ()=>{ $('#proxyEndpoint').value=(S.load().proxyEndpoint||DEFAULTS.proxyEndpoint); $('#forceProxy').checked=!!S.load().forceProxy; $('#resetAfterSave').checked=S.load().resetAfterSave!==false; $('#dlg').showModal(); });
$('#saveSettings').addEventListener('click',(e)=>{ e.preventDefault(); const s=S.load(); s.proxyEndpoint=$('#proxyEndpoint').value.trim()||DEFAULTS.proxyEndpoint; s.forceProxy=$('#forceProxy').checked; s.resetAfterSave=$('#resetAfterSave').checked; S.save(s); $('#dlg').close(); toast('Impostazioni salvate.'); });
$('#tabScript').addEventListener('click', ()=>{ $('#tabScript').className='btn-accent'; $('#tabPitch').className='btn-ghost'; $('#scriptWrap').style.display='flex'; $('#pitchWrap').style.display='none'; });
$('#tabPitch').addEventListener('click', ()=>{ $('#tabPitch').className='btn-accent'; $('#tabScript').className='btn-ghost'; $('#scriptWrap').style.display='none'; $('#pitchWrap').style.display='flex'; });
$('#btnCopyContacts').addEventListener('click', copyContacts);
$('#btnOpenWA').addEventListener('click', ()=>openWA($('#phone').value));
$('#btnMailto').addEventListener('click', ()=>mailtoLead($('#email').value,$('#name').value));
$('#search').addEventListener('input', renderQueue);

renderQueue(); setGauge(0); setStatus('Pronto.');
</script>
</body>
</html>
