<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QPWON – Scoring Sprint (Auto-Analyzer · Proxy-Ready)</title>
  <meta name="description" content="Inserisci il link del centro. Il tool legge alcune pagine pubbliche, estrae segnali e calcola lo score per area. Proxy integrato per evitare CORS." />
  <style>
    :root{
      --bg:#0f1220; --bg2:#0c101d; --card:#151a2e; --edge:#283060;
      --text:#e7ecff; --muted:#9fb3db; --accent:#7c5cff;
      --good:#2ecc71; --warn:#f1c40f; --cold:#4aa3ff; --danger:#ff6b6b;
      --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,var(--bg),var(--bg2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    header{position:sticky;top:0;z-index:10;background:rgba(12,15,28,.75);backdrop-filter:blur(10px);border-bottom:1px solid #1d2447}
    .topbar{display:flex;gap:12px;align-items:center;padding:12px 16px}
    .brand{font-weight:800;letter-spacing:.2px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3260;background:#1b2143;color:var(--muted);font-size:12px}
    .spacer{flex:1}
    button{appearance:none;border:1px solid #2a3260;border-radius:10px;padding:10px 14px;background:#202955;color:#fff;cursor:pointer;box-shadow:var(--shadow);transition:filter .15s,transform .06s}
    button:hover{filter:brightness(1.05)}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent}
    .btn-accent{background:var(--accent);border-color:#543cff}
    .btn-good{background:var(--good);color:#092015;border-color:#1f9f52}
    .btn-danger{background:var(--danger);border-color:#ff6b6b}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #33407a;background:#0f1532;color:#e7ecff;outline:none}
    textarea{min-height:84px;resize:vertical}
    main{padding:18px;display:grid;gap:18px;grid-template-columns:1.3fr 1fr 1.1fr}
    @media (max-width:1200px){ main{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg,#1a2147,#111739);border:1px solid var(--edge);border-radius:var(--r);box-shadow:var(--shadow)}
    .card>h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--edge);font-size:16px;color:#cfe1ff;display:flex;align-items:center;gap:10px}
    .content{padding:14px 16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}
    .muted{color:var(--muted)}
    .progress{height:8px;border:1px solid #25305b;border-radius:999px;overflow:hidden;background:#0d1430}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--accent),#5c87ff);width:0%}
    .bookmarklet{display:flex;gap:10px;align-items:center;background:#0e1430;border:1px dashed #2a3260;padding:10px;border-radius:12px}
    .bookmarklet a{display:inline-block;padding:8px 10px;border:1px solid #2a3260;border-radius:8px;background:#1a2350;color:#fff}
    .gauge-wrap{display:flex;align-items:center;justify-content:center;padding:8px 0}
    .gauge{width:280px;height:160px}
    .needle{transform-origin:140px 140px;transition:transform .4s ease}
    .score-big{font-size:46px;font-weight:800;text-align:center;margin-top:-6px}
    .band{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:2px}
    .dot{width:12px;height:12px;border-radius:50%}
    .dot.cold{background:var(--cold)} .dot.warm{background:var(--warn)} .dot.hot{background:var(--good)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{font-size:13px;padding:8px 10px;text-align:left} thead th{color:#cfe1ff}
    tbody tr{background:#10163a;border:1px solid var(--edge)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:2px 6px;border-radius:999px;border:1px solid #33407a;font-size:11px;color:#cfe1ff}
    .conf-low{background:#241a3e} .conf-mid{background:#1f2b55} .conf-high{background:#1a3e2d}
    .actions button{padding:6px 10px;border-radius:8px}
    dialog::backdrop{background:rgba(0,0,0,.35)}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand">QPWON · <span class="muted">Scoring Sprint</span></div>
      <span class="pill">Auto-Analyzer · Proxy-ready</span>
      <div class="spacer"></div>
      <button id="btnSettings" class="btn-ghost">Impostazioni</button>
      <button id="btnTestProxy" class="btn-ghost">Test proxy</button>
      <button id="exportCSV" class="btn-ghost">Export CSV</button>
      <button id="exportJSON" class="btn-ghost">Export JSON</button>
      <label class="btn-ghost" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">Import JSON
        <input id="importJSON" type="file" accept="application/json" style="display:none" />
      </label>
      <button id="resetAll" class="btn-danger">Reset</button>
    </div>
  </header>

  <main>
    <!-- SEZIONE 1: URL -> ANALISI -->
    <section class="card">
      <h2>1) URL → Analisi automatica</h2>
      <div class="content col">
        <div class="row">
          <input id="url" type="url" placeholder="Incolla l'URL (es. https://www.polixyz.it)" />
          <button id="analyze" class="btn-accent">Analizza</button>
        </div>
        <div class="progress"><div id="pbar"></div></div>
        <div id="status" class="muted">Pronto.</div>
        <details>
          <summary class="muted">Se il sito blocca (CORS), ecco le alternative</summary>
          <div class="bookmarklet">
            <div>1) Trascina questo nei preferiti:</div>
            <a id="bm" href="#">Analizza questa pagina</a>
            <div>2) Vai sul sito del centro e cliccalo → copia il testo.<br/>3) Torna qui, incolla sotto e premi <b>Analizza testo</b>.</div>
          </div>
          <textarea id="pasted" placeholder="Incolla qui il testo copiato dal sito…"></textarea>
          <div class="row" style="justify-content:flex-end"><button id="analyzePasted" class="btn-ghost">Analizza testo</button></div>
        </details>
      </div>
    </section>

    <!-- SEZIONE 2: SCORE & AREE -->
    <section class="card">
      <h2>2) Score complessivo & aree</h2>
      <div class="content col">
        <div class="gauge-wrap">
          <div class="gauge">
            <svg viewBox="0 0 280 160" xmlns="http://www.w3.org/2000/svg" aria-label="Gauge">
              <defs>
                <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="var(--cold)"/>
                  <stop offset="50%" stop-color="var(--warn)"/>
                  <stop offset="100%" stop-color="var(--good)"/>
                </linearGradient>
              </defs>
              <path d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="#23305e" stroke-width="16" stroke-linecap="round"/>
              <path id="arc" d="M 20 140 A 120 120 0 0 1 260 140" fill="none" stroke="url(#grad)" stroke-width="16" stroke-linecap="round" stroke-dasharray="0 377"/>
              <g id="needle" class="needle">
                <line x1="140" y1="140" x2="140" y2="42" stroke="#e7ecff" stroke-width="4"/>
                <circle cx="140" cy="140" r="6" fill="#e7ecff"/>
              </g>
            </svg>
          </div>
        </div>
        <div class="score-big" id="scoreText">0.0</div>
        <div class="band"><span>Pallino:</span> <span class="dot cold" id="dot"></span> <span id="tempText" class="muted">freddo</span></div>
        <div class="muted" id="coverage">Copertura segnali: 0%</div>

        <table>
          <thead><tr><th>Area</th><th>Score</th><th>Confidenza</th><th>Evidenza</th></tr></thead>
          <tbody id="areasBody"></tbody>
        </table>
      </div>
    </section>

    <!-- SEZIONE 3: SCRIPT & CODA -->
    <section class="card">
      <h2>3) Script & coda</h2>
      <div class="content col">
        <label>Nome struttura</label>
        <input id="name" type="text" placeholder="Es. Poliambulatorio XYZ" />
        <label>Città</label>
        <input id="city" type="text" placeholder="Es. Bologna" />
        <label>Telefono (per chiamata/WA)</label>
        <input id="phone" type="tel" placeholder="+39…" />
        <label>Script (WhatsApp / Email)</label>
        <textarea id="script" placeholder="Verrà generato automaticamente…"></textarea>

        <div class="row" style="justify-content:flex-end; gap:8px">
          <button id="btnWA" class="btn-good">WhatsApp</button>
          <button id="btnCall">Chiama</button>
          <button id="btnEmail" class="btn-ghost">Email</button>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="saveQueue" class="btn-accent">Salva & metti in coda</button>
          <input id="search" type="text" placeholder="Cerca nella coda… (nome, città)" />
        </div>

        <table>
          <thead><tr><th>Priorità</th><th>Struttura</th><th>Città</th><th>Score</th><th>Azioni</th></tr></thead>
          <tbody id="queueBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODALE IMPOSTAZIONI -->
  <dialog id="dlg">
    <form method="dialog" style="min-width:min(680px,95vw);background:#0e1430;border:1px solid #2a3260;color:#e7ecff;border-radius:16px;padding:16px">
      <h3 style="margin:0 0 10px 0;">Impostazioni</h3>
      <div style="display:grid;gap:10px">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="forceProxy" /> Forza uso proxy per tutte le richieste
        </label>
        <div>
          <label>Endpoint Proxy (Cloudflare Worker o server tuo)</label>
          <input id="proxyEndpoint" type="url" placeholder="https://TUO-WORKER.workers.dev/?url=" />
          <div class="muted">Consigliato (già pronto per te): <code id="defaultEP"></code></div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button value="cancel" class="btn-ghost">Chiudi</button>
        <button id="saveSettings" class="btn-accent">Salva</button>
      </div>
    </form>
  </dialog>

  <script>
    // ==================== CONFIG & STATO ====================
    const DEFAULT_ENDPOINT = "https://qpwonscorepro.apesce-consulente.workers.dev/?url="; // il tuo Worker
    const STORAGE_KEY = "qpwon_scoring_v3";
    const DEFAULT_STATE = { proxyEndpoint: DEFAULT_ENDPOINT, forceProxy: true, leads: [] };

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const S = {
      load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_STATE; }catch{ return DEFAULT_STATE; } },
      save(v){ localStorage.setItem(STORAGE_KEY, JSON.stringify(v)); }
    };
    let state = S.load();

    // ==================== UI UTILS ====================
    function setStatus(msg){ $("#status").textContent = msg; }
    function setProgress(pct){ $("#pbar").style.width = pct + "%"; }
    function clamp(n,min,max){ return Math.min(max, Math.max(min, n)); }
    function esc(s){ return (s||"").replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function uuid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

    // Bookmarklet per recupero testo renderizzato (senza proxy)
    (function initBookmarklet(){
      const code = `(function(){try{var t=document.body.innerText||document.body.textContent||'';if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(t.slice(0,200000)).then(function(){alert('Testo copiato. Torna al tool e clicca \\'Analizza testo\\'.')}).catch(function(e){prompt('Copia questo testo e incollalo nel tool:',t.slice(0,8000))});}else{prompt('Copia questo testo e incollalo nel tool:',t.slice(0,8000));}}catch(e){alert('Errore: '+e.message)}})();`;
      $("#bm").setAttribute("href","javascript:"+encodeURIComponent(code));
    })();

    // ==================== HEURISTICS ====================
    const AREAS = ["booking","telefonate","orari","whatsapp","crescita","doppioSistema","dimensione","serviziCall","decisionMaker","numeroDiretto"];
    const WEIGHTS = { booking:2, telefonate:2, orari:1, whatsapp:1, crescita:2, doppioSistema:2, dimensione:2, serviziCall:1, decisionMaker:1, numeroDiretto:1 };

    function analyzeTexts(texts){
      const concat = texts.map(t => (t.text||"")+" ").join(" ").toLowerCase();
      const score = {}, conf = {}, evidence = {};

      const md = /miodottore/.test(concat), dl = /doctolib/.test(concat), book = /(prenota|prenotazione|booking|appuntamenti)/.test(concat);
      if(!book){ score.booking=10; conf.booking="mid"; evidence.booking="Nessuna traccia di prenotazione online"; }
      else if(md && dl){ score.booking=7; conf.booking="high"; evidence.booking="MD+DL entrambi presenti"; }
      else if(md || dl){ score.booking=6; conf.booking="high"; evidence.booking="Portale esterno rilevato"; }
      else { score.booking=5; conf.booking="mid"; evidence.booking="Prenotazione presente ma potenzialmente confusa"; }

      const telRe=/(linee occupate|sempre occupato|attesa|richiama|solo telefono|chiamare per prenotare)/;
      score.telefonate = telRe.test(concat) ? 8 : (book ? 3 : 7);
      conf.telefonate = telRe.test(concat) ? "mid" : "low";
      evidence.telefonate = telRe.test(concat) ? "Testo con attese/telefono" : "Indizio indiretto";

      const hasSat=/(sab|sabato)/.test(concat), times=concat.match(/\b([01]?\d|2[0-3]):[0-5]\d\b/g)||[], late=times.some(t=>{const[h,m]=t.split(":").map(Number);return h>19||(h===19&&m>=30)});
      score.orari = (hasSat||late) ? 8 : 3; conf.orari=(hasSat||late) ? "mid" : "low"; evidence.orari=(hasSat?"sabato ":"")+(late?"orari ≥19:30":"");

      const wa=/(wa\.me|api\.whatsapp|whatsapp)/.test(concat); score.whatsapp=wa?7:2; conf.whatsapp=wa?"high":"low"; evidence.whatsapp=wa?"Link/menzione WhatsApp":"Nessuna evidenza";

      const gr=/(nuova sede|apertura|stiamo assumendo|lavora con noi|apre|nuovo centro|nuovi macchinari|campagna|promozione)/.test(concat);
      score.crescita=gr?8:3; conf.crescita=gr?"mid":"low"; evidence.crescita=gr?"Parole chiave di crescita":"Nessuna evidenza";

      if(md&&dl){ score.doppioSistema=9; conf.doppioSistema="high"; evidence.doppioSistema="MD+DL rilevati"; } else { score.doppioSistema=2; conf.doppioSistema="mid"; evidence.doppioSistema="Nessun doppio sistema chiaro"; }

      const medRe=/(dott\.|dottore|dottoressa|dr\.|medico|specialista)/g; const hits=(concat.match(medRe)||[]).length;
      score.dimensione = (hits>=3 && hits<=20)?9 : (hits>20 && hits<=40)?6 : (hits>40)?5 : 3; conf.dimensione="low"; evidence.dimensione="Occorrenze parole-medico: "+hits;

      const hiRe=/(prelievi|analisi|fisioterapia|oculistica|ecografia|radiologia|tac|risonanza)/; score.serviziCall=hiRe.test(concat)?7:3; conf.serviziCall=hiRe.test(concat)?"mid":"low"; evidence.serviziCall=hiRe.test(concat)?"Servizi ad alta chiamata presenti":"Nessuna evidenza";

      const dmRe=/(direzione sanitaria|direttore sanitario|amministrazione|titolare|responsabile)/; score.decisionMaker=dmRe.test(concat)?7:3; conf.decisionMaker=dmRe.test(concat)?"mid":"low"; evidence.decisionMaker=dmRe.test(concat)?"Ruolo/contatto di direzione":"Nessuna evidenza";

      const ph=/((\+?39\s?)?0?\d[\d\s\-\.]{6,})/; const hasPh=ph.test(concat); const pre=/(prenotazioni|segreteria|cup|centralino|accettazione)/;
      score.numeroDiretto=hasPh?(pre.test(concat)?7:5):2; conf.numeroDiretto=hasPh?"mid":"low"; evidence.numeroDiretto=hasPh?"Telefono presente":"Nessuna evidenza";

      const coverage = Math.round(100 * (Object.keys(score).length / AREAS.length));
      return { score, conf, evidence, coverage };
    }

    function areaLabel(k){
      return ({
        booking:"Prenotazione online migliorabile/assente",
        telefonate:"Traffico telefonico/attese",
        orari:"Orari estesi/sabato (alto afflusso)",
        whatsapp:"WhatsApp presente (rischio non presidiato)",
        crescita:"Segnali di crescita (sede/assunzioni/adv)",
        doppioSistema:"Doppio sistema MD+DL",
        dimensione:"Taglia 3–20 medici (stimata)",
        serviziCall:"Servizi ad alta chiamata presenti",
        decisionMaker:"Decision maker identificabile",
        numeroDiretto:"Numero diretto/centralino rilevato"
      })[k] || k;
    }
    function confBadge(c){
      const map={low:"conf-low",mid:"conf-mid",high:"conf-high"};
      return '<span class="badge '+(map[c]||"conf-low")+'">'+(c||"low")+'</span>';
    }
    function renderAreas(score, conf, evidence){
      $("#areasBody").innerHTML = AREAS.map(a=>{
        const s = (score[a]??0).toFixed(1);
        const c = confBadge(conf[a]);
        const ev = evidence[a] ? esc(evidence[a]) : "—";
        return '<tr><td>'+areaLabel(a)+'</td><td>'+s+'</td><td>'+c+'</td><td>'+ev+'</td></tr>';
      }).join("");
    }
    function setGauge(val){
      $("#scoreText").textContent = val.toFixed(1);
      const t = (val>=8)?"hot":(val>=5)?"warm":"cold";
      $("#dot").className = "dot "+t;
      $("#tempText").textContent = (t==="hot"?"caldo":t==="warm"?"tiepido":"freddo");
      const deg = -90 + (clamp(val,0,10)/10)*180;
      $("#needle").style.transform = "rotate("+deg+"deg)";
      const L=377, shown=L*(clamp(val,0,10)/10);
      $("#arc").setAttribute("stroke-dasharray", shown+" "+(L-shown));
    }
    function overall(score){
      let sum=0, ws=0, reasons=[];
      for(const a of AREAS){ const s=score[a]??0, w=WEIGHTS[a]??1; sum+=s*w; ws+=10*w; if(s>=7) reasons.push([areaLabel(a), s]); }
      reasons.sort((A,B)=>B[1]-A[1]);
      return { final: Math.round((sum/ws)*100)/10, reasons: reasons.slice(0,3).map(r=>r[0]) };
    }
    function nextWorkingDay(d, add){
      const x=new Date(d); x.setDate(x.getDate()+add);
      const day=x.getDay(); if(day===6) x.setDate(x.getDate()+2); if(day===0) x.setDate(x.getDate()+1);
      return x;
    }
    function fmt(d){ const g=['dom','lun','mar','mer','gio','ven','sab']; return g[d.getDay()]+' '+String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
    function proposeSlots(){
      const d1=nextWorkingDay(new Date(),1); d1.setHours(11,30,0,0);
      const d2=nextWorkingDay(new Date(),2); d2.setHours(16,0,0,0);
      return [fmt(d1), fmt(d2)];
    }
    function buildScript(name, reasons){
      const slot=proposeSlots();
      const why = (reasons && reasons.length) ? " In 15' ti mostro: " + reasons.join(" · ") + "." : "";
      return "Ciao " + (name||"—") + ", seguo strutture come la tua per ridurre chiamate perse e aumentare appuntamenti integrando prenotazione online e gestione chiamate." + why + " Ti propongo " + slot[0] + " o " + slot[1] + " su Meet. Quale preferisci?";
    }

    // ==================== FETCH HELPERS ====================
    async function fetchDirect(url){
      const res = await fetch(url, { credentials:"omit" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      return { html };
    }
    async function fetchViaProxy(url){
      const endpoint = (state.proxyEndpoint || DEFAULT_ENDPOINT).trim();
      if(!endpoint) throw new Error("Proxy non configurato");
      const res = await fetch(endpoint + encodeURIComponent(url), { credentials:"omit" });
      if(!res.ok) throw new Error("Proxy HTTP "+res.status);
      const data = await res.json();
      if(!data || !data.html) throw new Error("Risposta proxy non valida");
      return { html: data.html };
    }
    function extractText(html){
      try{
        const doc = new DOMParser().parseFromString(html,"text/html");
        doc.querySelectorAll("script,style,noscript,svg,nav,footer").forEach(n=>n.remove());
        return (doc.body?.innerText||"").replace(/\s+/g," ").trim();
      }catch(e){
        return html.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
      }
    }
    function abs(base, href){ try{ return new URL(href, base).href; }catch{ return null; } }
    function pickLinks(base, html){
      const doc = new DOMParser().parseFromString(html,"text/html");
      const want = /(medici|equipe|staff|team|chi-siamo|servizi|prestazioni|contatti|prenota|booking)/i;
      const links = Array.from(doc.querySelectorAll("a[href]")).map(a=>a.getAttribute("href")).filter(Boolean);
      const out = []; for(const h of links){ if(want.test(h)){ const u = abs(base, h); if(u && !out.includes(u)) out.push(u); } }
      return out.slice(0,3);
    }

    // ==================== ANALISI ====================
    async function analyzeFromUrl(){
      const urlInput = $("#url").value.trim();
      if(!urlInput){ alert("Inserisci un URL."); return; }
      setStatus("Lettura pagina principale…"); setProgress(10);
      let base; try{ base = new URL(urlInput).origin; }catch{ alert("URL non valido"); return; }
      const texts = [];
      try{
        let main;
        if(state.forceProxy){ main = await fetchViaProxy(urlInput); }
        else {
          try{ main = await fetchDirect(urlInput); }
          catch(e){ setStatus("CORS bloccato: passo al proxy…"); main = await fetchViaProxy(urlInput); }
        }
        const mainText = extractText(main.html);
        texts.push({ url:urlInput, html:main.html, text:mainText });

        setStatus("Estrazione link interni…"); setProgress(40);
        const links = pickLinks(base, main.html);

        setStatus("Lettura sottopagine…"); setProgress(60);
        for(const l of links){
          try{
            let sub;
            if(state.forceProxy){ sub = await fetchViaProxy(l); }
            else { try{ sub = await fetchDirect(l); }catch{ sub = await fetchViaProxy(l); } }
            texts.push({ url:l, html:sub.html, text:extractText(sub.html) });
          }catch{ /* skip */ }
        }

        setStatus("Valutazione aree…"); setProgress(80);
        const { score, conf, evidence, coverage } = analyzeTexts(texts);
        renderAreas(score, conf, evidence);
        $("#coverage").textContent = "Copertura segnali: " + coverage + "%";

        const { final, reasons } = overall(score);
        setGauge(final);
        $("#script").value = buildScript($("#name").value, reasons);
        window.__lastAnalysis = { final, reasons };
        setStatus("Fatto."); setProgress(100);
      }catch(err){
        console.error(err);
        setStatus("Impossibile leggere il sito. Controlla il proxy in Impostazioni.");
        setProgress(0);
      }
    }

    async function analyzeFromPasted(){
      const t = $("#pasted").value.trim(); if(!t){ alert("Incolla del testo"); return; }
      setStatus("Analisi del testo incollato…"); setProgress(60);
      const { score, conf, evidence, coverage } = analyzeTexts([{url:"pasted://", html:"", text:t}]);
      renderAreas(score, conf, evidence);
      $("#coverage").textContent = "Copertura segnali: " + coverage + "%";
      const { final, reasons } = overall(score);
      setGauge(final);
      $("#script").value = buildScript($("#name").value, reasons);
      window.__lastAnalysis = { final, reasons };
      setStatus("Fatto."); setProgress(100);
    }

    // ==================== CODA & AZIONI ====================
    function temperature(v){ return (v>=8)?"hot":(v>=5)?"warm":"cold"; }
    function renderQueue(){
      const term = $("#search").value?.toLowerCase()||"";
      const rows = (state.leads||[]).slice().sort((a,b)=> b.score - a.score || a.createdAt - b.createdAt)
        .filter(l => !term || l.name.toLowerCase().includes(term) || (l.city||"").toLowerCase().includes(term))
        .map(l => `
        <tr data-id="${l.id}">
          <td><span class="dot ${l.temp||'cold'}"></span></td>
          <td>${esc(l.name)}</td>
          <td>${esc(l.city||'')}</td>
          <td>${l.score.toFixed(1)}</td>
          <td class="actions">
            <button data-act="wa">WA</button>
            <button data-act="call">Chiama</button>
            <button data-act="mail" class="btn-ghost">Email</button>
            <button data-act="del" class="btn-danger">Elimina</button>
          </td>
        </tr>`).join("");
      $("#queueBody").innerHTML = rows || `<tr><td colspan="5" class="muted">Nessun lead salvato.</td></tr>`;
      // Bind actions
      $$("#queueBody [data-act]").forEach(btn => btn.addEventListener("click", onLeadAction));
    }
    function onLeadAction(e){
      const tr = e.target.closest("tr"); const id = tr.getAttribute("data-id");
      const lead = (state.leads||[]).find(x=>x.id===id); if(!lead) return;
      const act = e.target.getAttribute("data-act");
      if(act==="del"){
        state.leads = (state.leads||[]).filter(x=>x.id!==id); S.save(state); renderQueue(); return;
      }
      if(act==="call"){
        if(!lead.phone){ alert("Telefono mancante su questo lead."); return; }
        window.location.href = "tel:"+lead.phone.replace(/\s+/g,"");
        return;
      }
      const text = lead.script || buildScript(lead.name, lead.reasons||[]);
      if(act==="wa"){
        const phone = (lead.phone||"").replace(/[^\d]/g,"");
        if(!phone){ alert("Telefono mancante per WhatsApp."); return; }
        const u = "https://wa.me/"+phone+"?text="+encodeURIComponent(text);
        window.open(u, "_blank");
      } else if(act==="mail"){
        const subject = "Proposta breve per " + (lead.name||"la vostra struttura");
        const u = "mailto:?subject="+encodeURIComponent(subject)+"&body="+encodeURIComponent(text);
        window.location.href = u;
      }
    }
    function addToQueue(){
      const la = window.__lastAnalysis||{final:0,reasons:[]};
      const lead = {
        id: uuid(),
        name: $("#name").value.trim()||"—",
        city: $("#city").value.trim(),
        phone: $("#phone").value.trim(),
        url: $("#url").value.trim(),
        score: la.final,
        temp: temperature(la.final),
        reasons: la.reasons,
        script: $("#script").value.trim(),
        createdAt: Date.now()
      };
      state.leads = state.leads||[]; state.leads.push(lead); S.save(state); renderQueue();
      alert("Aggiunto in coda.");
    }

    // ==================== EXPORT / IMPORT ====================
    function exportJSON(){
      const blob=new Blob([JSON.stringify({leads:state.leads||[]},null,2)],{type:"application/json"});
      const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="qpwon_scoring_export.json"; a.click(); URL.revokeObjectURL(url);
    }
    function exportCSV(){
      const cols=["nome","città","url","telefono","score","temperatura","motivi"];
      const rows=(state.leads||[]).map(l=>[wrap(l.name),wrap(l.city||""),wrap(l.url||""),wrap(l.phone||""),l.score.toFixed(1),l.temp,wrap((l.reasons||[]).join(" | "))].join(","));
      const csv=[cols.join(","),...rows].join("\n"); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
      const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="qpwon_scoring_export.csv"; a.click(); URL.revokeObjectURL(url);
      function wrap(s){ s=(s||"").toString().replaceAll('"','""'); return '"'+s+'"'; }
    }
    function onImportJSON(e){
      const f=e.target.files[0]; if(!f) return;
      f.text().then(t=>{
        try{
          const data=JSON.parse(t);
          if(data && Array.isArray(data.leads)){ state.leads=data.leads; S.save(state); renderQueue(); alert("Import completato."); }
          else alert("File non valido.");
        }catch(err){ alert("Errore import: "+err.message); }
      }).finally(()=>{ e.target.value=""; });
    }

    // ==================== IMPOSTAZIONI & TEST PROXY ====================
    function openSettings(){
      $("#proxyEndpoint").value = state.proxyEndpoint || DEFAULT_ENDPOINT;
      $("#forceProxy").checked = !!state.forceProxy;
      $("#defaultEP").textContent = DEFAULT_ENDPOINT;
      $("#dlg").showModal();
    }
    function saveSettings(e){
      e.preventDefault();
      state.proxyEndpoint = $("#proxyEndpoint").value.trim() || DEFAULT_ENDPOINT;
      state.forceProxy = $("#forceProxy").checked;
      S.save(state);
      $("#dlg").close();
      alert("Impostazioni salvate.");
    }
    async function testProxy(){
      const ep = (state.proxyEndpoint||DEFAULT_ENDPOINT).trim();
      if(!ep){ alert("Configura prima l'endpoint del proxy."); return; }
      setStatus("Test proxy…");
      try{
        const res = await fetch(ep + encodeURIComponent("https://www.example.com"), { credentials:"omit" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const j = await res.json();
        if(j && j.html) { setStatus("Proxy OK ✔"); alert("Proxy OK: risposta valida ricevuta."); }
        else throw new Error("Formato non valido");
      }catch(err){ setStatus("Proxy KO ✖"); alert("Proxy KO: "+err.message); }
    }

    // ==================== BINDINGS ====================
    $("#analyze").addEventListener("click", analyzeFromUrl);
    $("#analyzePasted").addEventListener("click", analyzeFromPasted);

    $("#saveQueue").addEventListener("click", addToQueue);
    $("#search").addEventListener("input", renderQueue);

    $("#exportJSON").addEventListener("click", exportJSON);
    $("#exportCSV").addEventListener("click", exportCSV);
    $("#importJSON").addEventListener("change", onImportJSON);

    $("#btnSettings").addEventListener("click", openSettings);
    $("#saveSettings").addEventListener("click", saveSettings);
    $("#btnTestProxy").addEventListener("click", testProxy);

    $("#resetAll").addEventListener("click", ()=>{
      if(confirm("Eliminare tutti i lead e ripristinare le impostazioni?")){
        state = {...DEFAULT_STATE}; S.save(state); renderQueue(); setGauge(0); setStatus("Pronto."); setProgress(0);
      }
    });

    $("#btnWA").addEventListener("click", ()=>{
      const phone = ($("#phone").value||"").replace(/[^\d]/g,"");
      if(!phone){ alert("Inserisci il numero di telefono."); return; }
      const text = $("#script").value || buildScript($("#name").value, (window.__lastAnalysis?.reasons)||[]);
      const url = "https://wa.me/"+phone+"?text="+encodeURIComponent(text);
      window.open(url,"_blank");
    });
    $("#btnCall").addEventListener("click", ()=>{
      const phone = ($("#phone").value||"").trim();
      if(!phone){ alert("Inserisci il numero di telefono."); return; }
      window.location.href = "tel:"+phone.replace(/\s+/g,"");
    });
    $("#btnEmail").addEventListener("click", ()=>{
      const subject = "Proposta breve per " + ($("#name").value||"la vostra struttura");
      const body = $("#script").value || buildScript($("#name").value, (window.__lastAnalysis?.reasons)||[]);
      const url = "mailto:?subject="+encodeURIComponent(subject)+"&body="+encodeURIComponent(body);
      window.location.href = url;
    });

    // ==================== INIT ====================
    renderQueue(); setGauge(0); setStatus("Pronto."); setProgress(0);
  </script>
</body>
</html>

